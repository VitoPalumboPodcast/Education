<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Analisi grammaticale guidata</title>
<style>
  :root{
    --bg:#f7faff; --panel:#ffffff; --ink:#1f2937; --accent:#2563eb; --accent-soft:#dbeafe;
    --good:#16a34a; --bad:#dc2626; --card:#fff; --border:#dbe3f0; --muted:#eef3fb;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  h1{margin:0;font-size:clamp(20px,4vw,32px);color:var(--accent)}
  .wrap{max-width:980px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:16px}

  header{display:flex;flex-direction:column;gap:12px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px}

  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .toolbar button,.toolbar select{border-radius:12px;border:1px solid var(--border);background:var(--panel);padding:8px 14px;font-size:16px;font-weight:600;color:var(--accent);cursor:pointer}
  .toolbar button:focus-visible,.option:focus-visible{outline:3px solid #93c5fd}
  .toolbar button:hover{background:var(--accent-soft)}
  .toolbar button[data-pressed="true"]{background:var(--accent);color:#fff}

  .info-panel{display:none;flex-direction:column;gap:8px;border-radius:12px;padding:16px;background:var(--muted);color:var(--ink);line-height:1.6}
  .info-panel[aria-hidden="false"]{display:flex}
  .info-panel h1{margin:0;font-size:clamp(20px,4vw,32px);color:var(--accent)}
  .info-panel p{margin:0;font-size:17px}
  .info-panel strong{color:var(--accent)}

  .board{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:18px;display:flex;flex-direction:column;gap:18px;box-shadow:0 10px 28px rgba(37,99,235,.08)}
  .sentence{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
  .token{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:12px 16px;display:flex;flex-direction:column;align-items:center;gap:6px;min-width:80px;transition:transform .2s,border-color .2s,box-shadow .2s}
  .token .icon{font-size:34px}
  .token .word{font-size:18px;font-weight:700;text-align:center}
  .token[data-state="done"]{border-color:var(--good)}
  .token[data-state="active"]{border-color:var(--accent);transform:translateY(-4px);box-shadow:0 12px 24px rgba(37,99,235,.16);position:relative;animation:pulseGlow 2s ease-in-out infinite}
  .token[data-state="active"]::after{content:"";position:absolute;inset:-10px;border-radius:20px;background:radial-gradient(circle at center, rgba(37,99,235,.35), rgba(37,99,235,0));z-index:-1;animation:pulseHalo 2s ease-in-out infinite}

  .question{font-size:clamp(20px,4.2vw,34px);font-weight:800;text-align:center;margin:0}
  .step-hint{text-align:center;font-size:18px;margin:0;color:#475569}
  .options{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
  .option{border-radius:14px;border:2px solid var(--border);background:var(--card);padding:14px 16px;font-size:18px;font-weight:700;cursor:pointer;text-align:center;transition:transform .15s,box-shadow .15s,border-color .2s,color .2s}
  .option:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(15,23,42,.08)}
  .option[disabled]{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none}

  .feedback{min-height:46px;border-radius:14px;padding:12px;font-weight:700;text-align:center;font-size:18px}
  .feedback.ok{background:color-mix(in srgb, var(--good) 12%, white);color:#065f46}
  .feedback.bad{background:color-mix(in srgb, var(--bad) 12%, white);color:#7f1d1d}
  .feedback .error-count{display:block;margin-top:6px;font-size:14px;font-weight:600;color:#ca8a04}

  .progress{display:flex;justify-content:space-between;align-items:center;font-size:16px;color:#475569}
  .progress strong{color:var(--accent)}
  .next-word{display:none;justify-content:center}
  .next-word button{border-radius:999px;border:none;background:var(--accent);color:#fff;font-size:18px;font-weight:700;padding:12px 22px;cursor:pointer;box-shadow:0 10px 20px rgba(37,99,235,.2)}
  .next-word button:hover{background:#1d4ed8}
  .next-word[data-visible="true"]{display:flex}

  @keyframes pulseGlow{
    0%,100%{transform:translateY(-4px) scale(1);box-shadow:0 12px 24px rgba(37,99,235,.16)}
    50%{transform:translateY(-6px) scale(1.03);box-shadow:0 18px 32px rgba(37,99,235,.28)}
  }

  @keyframes pulseHalo{
    0%,100%{opacity:.65;transform:scale(.95)}
    50%{opacity:0;transform:scale(1.15)}
  }

  @media (max-width:640px){
    .question{font-size:24px}
    .option{font-size:17px}
  }

  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
  <div class="wrap" role="application" aria-describedby="help">
    <header>
      <div class="toolbar" role="group" aria-label="Controlli frase">
        <label class="sr-only" for="sentencePicker">Scegli frase</label>
        <select id="sentencePicker" title="Scegli una frase"></select>
        <button type="button" id="shuffle" title="Cambia frase casualmente" aria-label="Cambia frase casualmente">üé≤</button>
        <button type="button" id="restart" title="Ricomincia la parola corrente" aria-label="Ricomincia la parola corrente">üîÑ</button>
        <button type="button" id="infoToggle" aria-expanded="false" aria-controls="infoPanel" title="Mostra informazioni" aria-label="Mostra informazioni">‚ÑπÔ∏è</button>
      </div>
      <div class="info-panel" id="infoPanel" aria-hidden="true">
        <h1 tabindex="-1">Allenatore di analisi grammaticale</h1>
        <p id="help">Lavora su una <strong>parola alla volta</strong>: scegli la parte del discorso, quindi i tratti morfologici richiesti (genere, numero, tipo...). Ogni risposta viene verificata subito e al termine di ogni parola ricevi un messaggio riepilogativo.</p>
      </div>
    </header>

    <section class="board" aria-live="polite">
      <div class="progress" aria-live="polite">
        <span id="progressSentence"></span>
        <span id="progressWord"></span>
      </div>

      <div class="sentence" id="sentence" aria-label="Parole della frase"></div>

      <div>
        <p class="question" id="question">Scegli una risposta per iniziare.</p>
        <p class="step-hint" id="stepHint"></p>
      </div>

      <div class="options" id="options" role="group" aria-label="Possibili risposte"></div>

      <div class="feedback" id="feedback" role="status"></div>

      <div class="next-word" id="nextWord">
        <button type="button" id="nextWordBtn">Prosegui con la parola successiva</button>
      </div>
    </section>
  </div>

<script>
const SENTENCE_BANK_URL = 'data/analisi-grammaticale-sentences.json';
let SENTENCES = [];

let currentSentence = null;
let wordQueue = [];
let currentWord = null;
let stepIndex = 0;
let wrongAttemptsForWord = 0;
let controlsInitialized = false;

const sentencePicker = document.getElementById('sentencePicker');
const sentenceEl = document.getElementById('sentence');
const questionEl = document.getElementById('question');
const stepHint = document.getElementById('stepHint');
const optionsEl = document.getElementById('options');
const feedbackEl = document.getElementById('feedback');
const nextWordContainer = document.getElementById('nextWord');
const nextWordBtn = document.getElementById('nextWordBtn');
const infoToggle = document.getElementById('infoToggle');
const infoPanel = document.getElementById('infoPanel');
let autoAdvanceTimer = null;
const progressSentence = document.getElementById('progressSentence');
const progressWord = document.getElementById('progressWord');
const shuffleBtn = document.getElementById('shuffle');
const restartBtn = document.getElementById('restart');

function init(){
  if(!controlsInitialized){
    sentencePicker.addEventListener('change',()=>{
      const selectedIndex = Number.parseInt(sentencePicker.value, 10);
      loadSentence(Number.isNaN(selectedIndex) ? 0 : selectedIndex);
    });
    shuffleBtn.addEventListener('click',()=>{
      if(!SENTENCES.length){
        return;
      }
      const randomIndex = Math.floor(Math.random()*SENTENCES.length);
      sentencePicker.value = String(randomIndex);
      loadSentence(randomIndex,true);
    });
    restartBtn.addEventListener('click',()=>{
      if(!SENTENCES.length){
        return;
      }
      if(!currentWord){
        const selectedIndex = Number.parseInt(sentencePicker.value, 10);
        loadSentence(Number.isNaN(selectedIndex) ? 0 : selectedIndex);
        return;
      }
      stepIndex = 0;
      wrongAttemptsForWord = 0;
      feedbackEl.textContent = '';
      feedbackEl.className = 'feedback';
      nextWordContainer.dataset.visible = 'false';
      renderQuestion();
    });
    nextWordBtn.addEventListener('click',()=>{
      advanceWord();
    });
    infoToggle.addEventListener('click',toggleInfoPanel);
    controlsInitialized = true;
  }

  sentencePicker.innerHTML='';
  SENTENCES.forEach((s,idx)=>{
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = s.label;
    sentencePicker.appendChild(opt);
  });

  if(!SENTENCES.length){
    handleEmptyBank();
    return;
  }

  sentencePicker.value = '0';
  loadSentence(0);
}

function loadSentence(index,shuffle=false){
  clearAutoAdvance();
  if(!SENTENCES.length){
    handleEmptyBank();
    return;
  }

  const safeIndex = Number.isInteger(index) && index >= 0 && index < SENTENCES.length ? index : 0;
  currentSentence = SENTENCES[safeIndex];
  sentencePicker.value = String(safeIndex);
  const tokens = Array.isArray(currentSentence?.tokens) ? currentSentence.tokens : [];
  wordQueue = tokens.map(t=>({ ...t }));
  if(shuffle){
    wordQueue = shuffleArray(wordQueue);
  }
  currentWord = null;
  stepIndex = 0;
  wrongAttemptsForWord = 0;
  renderSentence();
  feedbackEl.textContent='Scegli una parola con le risposte proposte.';
  feedbackEl.className='feedback';
  progressSentence.textContent = `Frase ${safeIndex+1} di ${SENTENCES.length}`;
  progressWord.textContent = '';
  nextWordContainer.dataset.visible = 'false';
  advanceWord();
}

function renderSentence(){
  sentenceEl.innerHTML='';
  if(!currentSentence || !Array.isArray(currentSentence.tokens)){
    return;
  }
  currentSentence.tokens.forEach(token=>{
    const card = document.createElement('div');
    card.className='token';
    card.dataset.id = token.id;
    if(currentWord && token.id === currentWord.id){
      card.dataset.state='active';
    }else if(wordQueue.findIndex(t=>t.id===token.id) === -1){
      card.dataset.state='done';
    }
    const icon = document.createElement('div');
    icon.className='icon';
    icon.textContent = token.icon;
    const text = document.createElement('div');
    text.className='word';
    text.textContent = token.label;
    card.append(icon,text);
    sentenceEl.appendChild(card);
  });
}

function renderQuestion(){
  if(!currentSentence){
    questionEl.textContent = 'Nessuna frase disponibile.';
    stepHint.textContent = '';
    optionsEl.innerHTML='';
    feedbackEl.textContent = '';
    nextWordContainer.dataset.visible='false';
    progressWord.textContent = '';
    return;
  }

  if(!currentWord){
    questionEl.textContent = 'Frase completata!';
    stepHint.textContent = 'Hai terminato tutte le parole di questa frase. Cambia frase o ricarica per ripetere.';
    optionsEl.innerHTML='';
    feedbackEl.textContent = '';
    nextWordContainer.dataset.visible='false';
    progressWord.textContent = '';
    renderSentence();
    return;
  }
  const step = currentWord.steps[stepIndex];
  questionEl.textContent = step.question;
  stepHint.textContent = `Parola: ¬´${currentWord.label}¬ª ¬∑ Passo ${stepIndex+1} di ${currentWord.steps.length}`;
  optionsEl.innerHTML='';
  step.choices.forEach(choice=>{
    const btn = document.createElement('button');
    btn.className='option';
    btn.type='button';
    btn.textContent=choice;
    btn.dataset.value=choice;
    btn.addEventListener('click',()=>handleAnswer(choice));
    optionsEl.appendChild(btn);
  });
  feedbackEl.textContent='';
  feedbackEl.className='feedback';
  nextWordContainer.dataset.visible='false';
  progressWord.textContent = `Parola ${currentSentence.tokens.length - wordQueue.length} di ${currentSentence.tokens.length}`;
  renderSentence();
}

function handleAnswer(choice){
  const step = currentWord.steps[stepIndex];
  if(choice === step.answer){
    feedbackEl.textContent = '‚úÖ Corretto!';
    feedbackEl.className = 'feedback ok';
    stepIndex += 1;
    if(stepIndex >= currentWord.steps.length){
      finishWord();
    }else{
      setTimeout(()=>{ renderQuestion(); }, 500);
    }
  }else{
    wrongAttemptsForWord += 1;
    feedbackEl.textContent = '‚ùå Risposta errata, prova di nuovo.';
    feedbackEl.className = 'feedback bad';
  }
}

function finishWord(){
  clearAutoAdvance();
  const wordLabel = `¬´${currentWord.label}¬ª`;
  let summary = '';
  if(wrongAttemptsForWord === 0){
    summary = `${wordLabel} completata senza errori!`;
    feedbackEl.textContent = summary;
  }else{
    const errorLabel = `Errori commessi: ${wrongAttemptsForWord}`;
    summary = `${wordLabel} completata!`;
    feedbackEl.innerHTML = `${summary}<span class="error-count">${errorLabel}</span>`;
  }
  feedbackEl.className = 'feedback ok';
  nextWordContainer.dataset.visible='true';
  scheduleAutoAdvance();
}

function advanceWord(){
  clearAutoAdvance();
  if(wordQueue.length === 0){
    currentWord = null;
    renderSentence();
    renderQuestion();
    return;
  }
  currentWord = wordQueue.shift();
  stepIndex = 0;
  wrongAttemptsForWord = 0;
  renderQuestion();
}

function shuffleArray(array){
  const clone = [...array];
  for(let i = clone.length - 1; i > 0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [clone[i], clone[j]] = [clone[j], clone[i]];
  }
  return clone;
}

function setControlsDisabled(disabled){
  [sentencePicker, shuffleBtn, restartBtn, nextWordBtn, infoToggle].forEach(ctrl=>{
    if(ctrl){
      ctrl.disabled = disabled;
    }
  });
}

function toggleInfoPanel(){
  const isOpen = infoToggle.getAttribute('aria-expanded') === 'true';
  const nextState = !isOpen;
  infoToggle.setAttribute('aria-expanded', String(nextState));
  infoToggle.dataset.pressed = String(nextState);
  infoPanel.setAttribute('aria-hidden', String(!nextState));
  if(nextState){
    infoPanel.querySelector('h1')?.focus?.();
  }
}

function scheduleAutoAdvance(){
  clearAutoAdvance();
  autoAdvanceTimer = setTimeout(()=>{
    advanceWord();
  }, 1600);
}

function clearAutoAdvance(){
  if(autoAdvanceTimer){
    clearTimeout(autoAdvanceTimer);
    autoAdvanceTimer = null;
  }
}

async function loadSentenceBank(){
  const response = await fetch(SENTENCE_BANK_URL, { cache: 'no-store' });
  if(!response.ok){
    throw new Error(`Richiesta non riuscita (${response.status})`);
  }
  const data = await response.json();
  if(!Array.isArray(data)){
    throw new Error('Formato del file non valido');
  }
  SENTENCES = data;
}

function handleEmptyBank(){
  clearAutoAdvance();
  setControlsDisabled(true);
  currentSentence = null;
  currentWord = null;
  wordQueue = [];
  stepIndex = 0;
  wrongAttemptsForWord = 0;
  sentencePicker.innerHTML = '';
  sentenceEl.innerHTML = '';
  questionEl.textContent = 'Nessuna frase disponibile.';
  stepHint.textContent = 'Aggiungi frasi al file data/analisi-grammaticale-sentences.json per iniziare.';
  optionsEl.innerHTML = '';
  feedbackEl.textContent = 'Carica una banca di frasi valida per allenarti.';
  feedbackEl.className = 'feedback';
  progressSentence.textContent = '';
  progressWord.textContent = '';
  nextWordContainer.dataset.visible = 'false';
}

function handleBankError(error){
  console.error('Errore durante il caricamento della banca di frasi:', error);
  clearAutoAdvance();
  setControlsDisabled(true);
  currentSentence = null;
  currentWord = null;
  wordQueue = [];
  stepIndex = 0;
  wrongAttemptsForWord = 0;
  sentencePicker.innerHTML = '';
  sentenceEl.innerHTML = '';
  questionEl.textContent = 'Impossibile caricare le frasi.';
  stepHint.textContent = 'Verifica che il file data/analisi-grammaticale-sentences.json esista e sia formattato correttamente.';
  optionsEl.innerHTML = '';
  feedbackEl.textContent = 'Errore durante il caricamento della banca di frasi.';
  feedbackEl.className = 'feedback bad';
  progressSentence.textContent = '';
  progressWord.textContent = '';
  nextWordContainer.dataset.visible = 'false';
}

async function bootstrap(){
  setControlsDisabled(true);
  feedbackEl.textContent = 'Caricamento frasi in corso...';
  feedbackEl.className = 'feedback';
  try{
    await loadSentenceBank();
    init();
    if(SENTENCES.length){
      setControlsDisabled(false);
    }
  }catch(error){
    handleBankError(error);
  }
}

document.addEventListener('DOMContentLoaded', bootstrap);
</script>
</body>
</html>
