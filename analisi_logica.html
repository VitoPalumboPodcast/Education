<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analisi logica â€“ Web App educativa</title>
  <style>
    /* Reset & layout */
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body { background: #f4f7f7; color: #222; min-height: 100vh; }
    button, select { cursor: pointer; border: none; padding: .5rem .9rem; border-radius: 6px; font-size: 1rem; }
    select { background: #fff; border: 1px solid #bbb; }

    /* Container */
    #app { display: flex; flex-direction: column; align-items: center; gap: 1rem; padding: 1.25rem; max-width: 1040px; width: min(100%, 1040px); margin: auto; }
    #topBar { display: flex; flex-wrap: wrap; gap: .8rem; justify-content: center; width: 100%; align-items: stretch; }
    #badge, #timerBox, #playerBox { padding: .5rem 1rem; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,.15); }
    #topBar > * { flex: 1 1 180px; text-align: center; }
    #progressWrap { width: 100%; max-width: 480px; height: 10px; background: #ddd; border-radius: 6px; overflow: hidden; }
    #progressBar { height: 100%; width: 0; background: #28a745; transition: width .3s; }
    #sentenceCard { position: relative; width: 100%; background: #ffffff; border-radius: 14px; padding: 1.2rem 1.4rem 1.4rem; box-shadow: 0 12px 35px rgba(0,0,0,.05); border: 1px solid #d8e7ec; overflow: hidden; }
    #sentenceCard::before { content: ""; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(0, 123, 255, 0.08), rgba(40, 167, 69, 0.08)); pointer-events: none; }
    .sentenceLabel { position: absolute; top: 14px; left: 16px; background: #0069d9; color: #fff; padding: .35rem .9rem; border-radius: 999px; font-weight: 700; letter-spacing: .3px; font-size: .95rem; box-shadow: 0 4px 12px rgba(0,0,0,.12); }
    #sentenceArea { position: relative; z-index: 1; min-height: 140px; padding: 1.4rem 1rem 1rem; margin-top: 1.6rem; border: 2px dashed #54b4ff; border-radius: 12px; width: 100%; text-align: center; font-size: 1.35rem; line-height: 2rem; word-break: break-word; background: #f8fbff; box-shadow: inset 0 1px 0 rgba(255,255,255,.7); }

    /* Blocks */
    .block { display: inline-block; margin: .2rem .3rem; padding: .2rem .4rem; border-radius: 6px; transition: .2s; cursor: pointer; }
    .block:hover:not(.solved) { background: #e0f7ff; transform: scale(1.05); }
    .block.active  { background: #fffbcc; }
    .block.solved  { background: #d6ffd8; cursor: default; }
    .block.flash   { animation: flashRed .6s; }
    @keyframes flashRed { 0%,100% { background: #ffb1b1 } 50% { background: #ffdada } }

    /* Selection area */
    #selectionArea { width: 100%; padding: 1rem; border-top: 2px solid #ddd; min-height: 160px; display: flex; flex-direction: column; align-items: center; gap: .8rem; }
    #options { display: flex; flex-wrap: wrap; gap: .5rem; justify-content: center; }
    .optionBtn {
      background: #e6e6e6;
      border: 1px solid #ccc;
      padding: .5rem 1rem;
      border-radius: 6px;
      transition: background-color .2s, border-color .2s;
    }
    .optionBtn:hover   { background-color: #cce5ff; border-color: #3399ff; }
    .optionBtn.correct { background-color: #4caf50; color: #fff; border-color: #388e3c; }
    .optionBtn.wrong   { background-color: #f44336; color: #fff; border-color: #c62828; }

    /* Hint & next */
    #hintBox { display: none; padding: .8rem 1rem; background: #fff3cd; border-left: 6px solid #f0ad4e; border-radius: 8px; width: 100%; max-width: 660px; line-height: 1.4; }
    #nextBtn { display: none; padding: .6rem 1.2rem; border-radius: 6px; background: #28a745; color: #fff; transition: background .2s; }
    #nextBtn:hover { background: #208438; }
    #changeSentenceBtn { padding: .6rem 1.2rem; border-radius: 6px; background: #007bff; color: #fff; transition: background .2s; }
    #changeSentenceBtn:hover { background: #0056b3; }
    #hintBtn { display: none; background: #ffd966; color: #4a3b00; border: 1px solid #e0b800; }
    #hintBtn:hover { background: #f2c94c; }

    /* Feedback */
    #feedback { display: none; width: 100%; max-width: 660px; padding: .6rem 1rem; border-radius: 8px; text-align: center; font-weight: 600; }
    #feedback.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    #feedback.error   { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: flex; align-items: center; justify-content: center; z-index: 999; visibility: hidden; opacity: 0; transition: .2s; }
    .modal.show { visibility: visible; opacity: 1; }
    .modalContent { background: #fff; padding: 1.4rem 2rem; border-radius: 12px; max-width: 600px; width: 90%; display: flex; flex-direction: column; gap: 1rem; }

    @media(max-width:900px) {
      #app { padding: 1rem; }
      #sentenceCard { padding: 1rem 1rem 1.2rem; }
      .sentenceLabel { top: 10px; left: 12px; font-size: .9rem; }
      #sentenceArea { font-size: 1.15rem; line-height: 1.8rem; padding: 1.1rem .9rem .9rem; }
      #selectionArea { align-items: stretch; }
    }

    @media(max-width:680px) {
      #topBar { justify-content: flex-start; }
      #progressWrap { max-width: 100%; }
      #controlsBox { width: 100%; justify-content: center; }
    }

    @media(max-width:560px) {
      html { font-size: 15px; }
      body { padding: 0; }
      #app { gap: .8rem; padding: .9rem; }
      #topBar { flex-direction: column; align-items: stretch; }
      #topBar > * { width: 100%; }
      #controlsBox { flex-direction: column; align-items: stretch; }
      #controlsBox label, #controlsBox select { width: 100%; }
      button, select { width: 100%; }
      #sentenceCard { padding: .95rem .9rem 1.1rem; border-radius: 12px; }
      #sentenceArea { font-size: 1.05rem; line-height: 1.6rem; padding: .85rem .8rem .8rem; text-align: left; }
      #selectionArea { align-items: stretch; }
      #options { flex-direction: column; width: 100%; }
      .optionBtn { width: 100%; text-align: center; }
      #hintBox, #feedback { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="topBar">
      <div id="badge">Punti: <span id="score">0</span>/100</div>
      <div id="timerBox">Tempo: <span id="timer">0</span>s</div>
      <div id="playerBox" style="display:none">Turno: <span id="playerNum">1</span></div>
      <button id="readBtn">ðŸ”Š Leggi frase</button>
      <button id="changeSentenceBtn">Cambia Frase</button>
      <div id="controlsBox" style="display:flex;flex-wrap:wrap;gap:.6rem;align-items:center">
        <label for="modeSel">ModalitÃ :</label>
        <select id="modeSel">
          <option value="single">Studio</option>
          <option value="guide">Guida</option>
          <option value="challenge">Sfida 2P</option>
        </select>
        <label for="levelSel">Livello:</label>
        <select id="levelSel">
          <option value="base">Base</option>
          <option value="intermedio">Intermedio</option>
          <option value="avanzato">Avanzato</option>
        </select>
      </div>
    </div>

    <div id="progressWrap"><div id="progressBar"></div></div>
    <div id="sentenceCard">
      <div class="sentenceLabel">Frase da analizzare</div>
      <div id="sentenceArea"></div>
    </div>

    <div id="selectionArea">
      <div id="question">Tocca un blocco per iniziare.</div>
      <div id="options"></div>
      <button id="hintBtn">ðŸ’¡ Suggerimento</button>
      <button id="nextBtn">Frase successiva âžœ</button>
    </div>

    <div id="hintBox"></div>
    <div id="feedback"></div>
  </div>

  <div id="reportModal" class="modal">
    <div class="modalContent" id="reportCnt"></div>
  </div>

  <audio id="sndOk" src="https://www.soundjay.com/human/applause-01.wav" preload="auto"></audio>
  <audio id="sndNo" src="https://www.soundjay.com/misc/beep-07.wav" preload="auto"></audio>

  <script>
    /* ------------------------- DATI & DESCRIZIONI ------------------------- */
    const LOGIC_DESC = {
      Soggetto:"indica chi o che cosa compie o subisce lâ€™azione.",
      Predicato:"Ã¨ il verbo, nucleo dell'enunciato.",
      Complemento:"aggiunge informazioni al nucleo della frase.",
      Attributo:"Ã¨ un aggettivo o un nome usato come aggettivo che si unisce a un nome.",
      Apposizione:"Ã¨ un nome che si unisce a un altro nome per determinarlo.",
      Vocazione:"indica la persona a cui ci si rivolge direttamente.",
      Esclamazione:"esprime stupore, meraviglia, dolore, ecc.",
      "predicativo del soggetto":"completa il soggetto dopo verbi copulativi.",
      "predicativo dell'oggetto":"completa lâ€™oggetto dopo verbi transitivi.",
      /* principali Complementi */
      oggetto:"precisa lâ€™ente coinvolto direttamente dall'azione.",
      "di luogo":"specifica dove avviene lâ€™azione.",
      "stato in luogo":"indica dove si trova il soggetto o l'oggetto.",
      "moto a luogo":"indica verso quale luogo si muove lâ€™azione.",
      "moto da luogo":"indica da quale luogo proviene lâ€™azione.",
      "moto per luogo":"indica attraverso quale luogo avviene lâ€™azione.",
      "di tempo":"indica quando avviene lâ€™azione.",
      "determinato":"indica un momento preciso.",
      "continuato":"indica la durata.",
      "di argomento":"precisa lâ€™argomento trattato.",
      "di modo":"descrive come avviene lâ€™azione.",
      "di termine":"indica il destinatario.",
      "di specificazione":"specifica o chiarisce il termine da cui dipende.",
      partitivo:"indica una parte di un tutto.",
      denominazione:"specifica il nome proprio associato a un comune.",
      agente:"indica chi compie lâ€™azione in frase passiva.",
      "causa efficiente":"cosa inanimata che compie lâ€™azione passiva.",
      causa:"spiega la ragione o motivo dellâ€™azione.",
      fine:"indica lo scopo.",
      strumento:"specifica il mezzo.",
      compagnia:"indica con chi avviene lâ€™azione.",
      unione:"indica con cosa avviene lâ€™azione.",
      paragone:"introduce il confronto.",
      limitazione:"definisce il vincolo entro cui vale.",
      colpa:"indica il reato o la mancanza.",
      pena:"indica la punizione inflitta.",
      vantaggio:"a beneficio di chi/cosa.",
      svantaggio:"a danno di chi/cosa.",
      abbondanza:"ciÃ² di cui si abbonda.",
      privazione:"ciÃ² di cui si Ã¨ privi.",
      qualitÃ :"descrive una qualitÃ .",
      etÃ :"indica l'etÃ .",
      materia:"indica la materia.",
      relazione:"indica con chi/cosa si ha relazione."
    };

    /* ------------------------- ARRAY DI FRASI COMPLETO ------------------------- */
    const DATA = [
      // Base
      { level:"base", text:"Il cane abbaia nel cortile.", blocks:[
        {txt:"Il cane",cat:"Soggetto"},
        {txt:"abbaia",cat:"Predicato"},
        {txt:"nel cortile",cat:"Complemento",subcat:"di luogo",subcat2:"stato in luogo"}
      ]},
      { level:"base", text:"La bicicletta di Marco Ã¨ rossa.", blocks:[
        {txt:"La bicicletta",cat:"Soggetto"},
        {txt:"di Marco",cat:"Complemento",subcat:"di specificazione"},
        {txt:"Ã¨ rossa",cat:"Predicato"}
      ]},
      { level:"base", text:"Ho mangiato della pizza.", blocks:[
        {txt:"Ho mangiato",cat:"Predicato"},
        {txt:"della pizza",cat:"Complemento",subcat:"partitivo"}
      ]},
      // Intermedio / avanzato ecc.
      { level:"intermedio", text:"La cittÃ  di Bologna Ã¨ affascinante.", blocks:[
        {txt:"La cittÃ  di Bologna",cat:"Soggetto"},
        {txt:"Ã¨ affascinante",cat:"Predicato"}
      ]},
      { level:"intermedio", text:"Il quadro Ã¨ stato dipinto da Leonardo.", blocks:[
        {txt:"Il quadro",cat:"Soggetto"},
        {txt:"Ã¨ stato dipinto",cat:"Predicato"},
        {txt:"da Leonardo",cat:"Complemento",subcat:"agente"}
      ]},
      { level:"intermedio", text:"Piange per la tristezza.", blocks:[
        {txt:"Piange",cat:"Predicato"},
        {txt:"per la tristezza",cat:"Complemento",subcat:"causa"}
      ]},
      { level:"intermedio", text:"Studia per superare lâ€™esame.", blocks:[
        {txt:"Studia",cat:"Predicato"},
        {txt:"per superare lâ€™esame",cat:"Complemento",subcat:"fine"}
      ]},
      { level:"intermedio", text:"Scrive con la penna.", blocks:[
        {txt:"Scrive",cat:"Predicato"},
        {txt:"con la penna",cat:"Complemento",subcat:"strumento"}
      ]},
      { level:"base", text:"Va al cinema con gli amici.", blocks:[
        {txt:"Va",cat:"Predicato"},
        {txt:"al cinema",cat:"Complemento",subcat:"di luogo",subcat2:"moto a luogo"},
        {txt:"con gli amici",cat:"Complemento",subcat:"compagnia"}
      ]},
      { level:"avanzato", text:"Corri piÃ¹ veloce di Marco.", blocks:[
        {txt:"Corri",cat:"Predicato"},
        {txt:"piÃ¹ veloce di Marco",cat:"Complemento",subcat:"paragone"}
      ]},
      { level:"avanzato", text:"Rimani entro le mura.", blocks:[
        {txt:"Rimani",cat:"Predicato"},
        {txt:"entro le mura",cat:"Complemento",subcat:"limitazione"}
      ]},
      { level:"avanzato", text:"Torna da scuola.", blocks:[
        {txt:"Torna",cat:"Predicato"},
        {txt:"da scuola",cat:"Complemento",subcat:"di luogo",subcat2:"moto da luogo"}
      ]},
      { level:"base", text:"Il piccolo cane abbaia.", blocks:[
        {txt:"Il piccolo",cat:"Attributo"},
        {txt:"cane",cat:"Soggetto"},
        {txt:"abbaia",cat:"Predicato"}
      ]},
      { level:"intermedio", text:"Ho letto un libro interessante.", blocks:[
        {txt:"Ho letto",cat:"Predicato"},
        {txt:"un libro",cat:"Complemento",subcat:"oggetto"},
        {txt:"interessante",cat:"Attributo"}
      ]},
      { level:"intermedio", text:"Marco, il mio amico, Ã¨ arrivato.", blocks:[
        {txt:"Marco",cat:"Soggetto"},
        {txt:"il mio amico",cat:"Apposizione"},
        {txt:"Ã¨ arrivato",cat:"Predicato"}
      ]},
      { level:"avanzato", text:"Ho incontrato Luca, il caposquadra.", blocks:[
        {txt:"Ho incontrato",cat:"Predicato"},
        {txt:"Luca",cat:"Complemento",subcat:"oggetto"},
        {txt:"il caposquadra",cat:"Apposizione"}
      ]},
      { level:"intermedio", text:"La casa Ã¨ stata distrutta dal terremoto.", blocks:[
        {txt:"La casa",cat:"Soggetto"},
        {txt:"Ã¨ stata distrutta",cat:"Predicato"},
        {txt:"dal terremoto",cat:"Complemento",subcat:"causa efficiente"}
      ]},
      { level:"intermedio", text:"Ãˆ uscito con il cane al guinzaglio.", blocks:[
        {txt:"Ãˆ uscito",cat:"Predicato"},
        {txt:"con il cane al guinzaglio",cat:"Complemento",subcat:"unione"}
      ]},
      { level:"avanzato", text:"Lo hanno accusato di furto.", blocks:[
        {txt:"Lo hanno accusato",cat:"Predicato"},
        {txt:"di furto",cat:"Complemento",subcat:"colpa"}
      ]},
      { level:"avanzato", text:"Ãˆ stato condannato a due anni.", blocks:[
        {txt:"Ãˆ stato condannato",cat:"Predicato"},
        {txt:"a due anni",cat:"Complemento",subcat:"pena"}
      ]},
      { level:"intermedio", text:"Ha lavorato per la sua famiglia.", blocks:[
        {txt:"Ha lavorato",cat:"Predicato"},
        {txt:"per la sua famiglia",cat:"Complemento",subcat:"vantaggio"}
      ]},
      { level:"avanzato", text:"Questo Ã¨ dannoso per la salute.", blocks:[
        {txt:"Questo",cat:"Soggetto"},
        {txt:"Ã¨ dannoso",cat:"Predicato"},
        {txt:"per la salute",cat:"Complemento",subcat:"svantaggio"}
      ]},
      { level:"avanzato", text:"La zona Ã¨ ricca di risorse.", blocks:[
        {txt:"La zona",cat:"Soggetto"},
        {txt:"Ã¨ ricca",cat:"Predicato"},
        {txt:"di risorse",cat:"Complemento",subcat:"abbondanza"}
      ]},
      { level:"avanzato", text:"Ãˆ privo di speranza.", blocks:[
        {txt:"Ãˆ privo",cat:"Predicato"},
        {txt:"di speranza",cat:"Complemento",subcat:"privazione"}
      ]},
      { level:"intermedio", text:"Un uomo di grande valore.", blocks:[
        {txt:"Un uomo",cat:"Soggetto"},
        {txt:"di grande valore",cat:"Complemento",subcat:"qualitÃ "}
      ]},
      { level:"base", text:"Mio fratello di otto anni gioca.", blocks:[
        {txt:"Mio fratello",cat:"Soggetto"},
        {txt:"di otto anni",cat:"Complemento",subcat:"etÃ "},
        {txt:"gioca",cat:"Predicato"}
      ]},
      { level:"intermedio", text:"Ha comprato un tavolo di legno.", blocks:[
        {txt:"Ha comprato",cat:"Predicato"},
        {txt:"un tavolo",cat:"Complemento",subcat:"oggetto"},
        {txt:"di legno",cat:"Complemento",subcat:"materia"}
      ]},
      { level:"avanzato", text:"Ho discusso con lui.", blocks:[
        {txt:"Ho discusso",cat:"Predicato"},
        {txt:"con lui",cat:"Complemento",subcat:"relazione"}
      ]},
      { level:"base", text:"Luca, vieni qui!", blocks:[
        {txt:"Luca",cat:"Vocazione"},
        {txt:"vieni",cat:"Predicato"},
        {txt:"qui",cat:"Complemento",subcat:"di luogo",subcat2:"moto a luogo"}
      ]},
      { level:"base", text:"Che bello!", blocks:[
        {txt:"Che bello",cat:"Esclamazione"}
      ]},
      { level:"avanzato", text:"Marco Ã¨ considerato intelligente.", blocks:[
        {txt:"Marco",cat:"Soggetto"},
        {txt:"Ã¨ considerato",cat:"Predicato"},
        {txt:"intelligente",cat:"predicativo del soggetto"}
      ]},
      { level:"avanzato", text:"Hanno eletto Paolo rappresentante.", blocks:[
        {txt:"Hanno eletto",cat:"Predicato"},
        {txt:"Paolo",cat:"Complemento",subcat:"oggetto"},
        {txt:"rappresentante",cat:"predicativo dell'oggetto"}
      ]}
    ];

    /* ------------------ CATEGORIE PRINCIPALI E SOTTOCATEGORIE ------------- */
    const CATS = [
      "Soggetto","Predicato","Complemento",
      "Attributo","Apposizione","Vocazione","Esclamazione",
      "predicativo del soggetto","predicativo dell'oggetto"
    ];
    const SUBS = Array.from(new Set(
      DATA.flatMap(s =>
        s.blocks.filter(b => b.cat==="Complemento" && b.subcat).map(b=>b.subcat)
      )
    ));

    /* ----------------------------- STATO ---------------------------------- */
    let state = {
      mode:"single", level:"base", sentences:[], idx:0,
      blockIdx:null, questionType:"cat", correct:0, attempts:0, timerId:null,
      turn:1, scores:[0,0]
    };

    /* ----------------------------- DOM ------------------------------------ */
    const $ = id=>document.getElementById(id);
    const sentenceArea=$("sentenceArea"),
          optionsDiv=$("options"),
          question=$("question"),
          scoreSpan=$("score"),
          timerSpan=$("timer"),
          hintBox=$("hintBox"),
          hintBtn=$("hintBtn"),
          nextBtn=$("nextBtn"),
          changeSentenceBtn=$("changeSentenceBtn"),
          progressBar=$("progressBar"),
          playerBox=$("playerBox"),
          playerNum=$("playerNum"),
          sndOk=$("sndOk"),
          sndNo=$("sndNo"),
          feedback=$("feedback");

    /* -------------------------- FUNZIONI AUSILIARIE ------------------------ */
    let audioUnlocked=false;
    addEventListener("click",()=>audioUnlocked=true,{once:true});

    function play(ok){
      if(!audioUnlocked) return;
      const s=ok? sndOk : sndNo;
      s.currentTime=0; s.play().catch(()=>{});
    }
    function speak(text){
      if(state.mode!=="guide") return;
      const u=new SpeechSynthesisUtterance(text);
      u.lang="it-IT"; speechSynthesis.speak(u);
    }
    function showFeedback(ok){
      feedback.textContent = ok ? "Risposta esatta!" : "Risposta errata, riprova.";
      feedback.className = ok ? "success" : "error";
      feedback.style.display = "block";
    }
    function clearFeedback(){
      feedback.textContent="";
      feedback.className="";
      feedback.style.display="none";
    }
    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
    }

    /* -------------------------- GESTIONE DATI ----------------------------- */
    function loadSentences(){
      state.sentences = DATA.filter(s=>s.level===state.level);
      shuffle(state.sentences);
      state.idx=0;
    }

    /* ----------------------------- TIMER & PUNTEGGIO ---------------------- */
    function startTimer(){
      clearInterval(state.timerId);
      state.attempts = 1;
      updateScore();
      timerSpan.textContent="0";
      state.timerId = setInterval(()=>{
        state.attempts++;
        updateScore();
        timerSpan.textContent = (state.attempts-1)*20; // mostra i secondi reali
      },20000);
    }

    function updateScore(){
      const sc = Math.round((state.correct/(state.attempts||1))*100)||0;
      scoreSpan.textContent = sc>100?100:sc;
    }

    /* --------------------------- RENDER DELLA FRASE ----------------------- */
    function render(){
      nextBtn.style.display="none";
      hintBox.style.display="none";
      hintBtn.style.display="none";
      hintBtn.disabled=true;
      state.blockIdx=null;
      state.questionType="cat";
      sentenceArea.innerHTML="";
      optionsDiv.innerHTML="";
      question.textContent="Tocca un blocco per iniziare.";
      clearFeedback();
      progressBar.style.width="0%";

      if(state.sentences.length===0){
        sentenceArea.textContent="Nessuna frase disponibile per questo livello.";
        return;
      }

      const s=state.sentences[state.idx];
      s.blocks.forEach((b,i)=>{
        const el=document.createElement("span");
        el.textContent=b.txt; el.className="block";
        el.addEventListener("click",()=>selectBlock(i));
        sentenceArea.appendChild(el);
      });

      state.correct=0;
      startTimer();
    }

    /* --------------------------- INTERAZIONE ------------------------------ */
    function selectBlock(i){
      if(sentenceArea.children[i].classList.contains("solved")) return;
      state.blockIdx=i;
      state.questionType="cat";
      hintBox.innerHTML="";
      hintBox.style.display="none";
      [...sentenceArea.children].forEach((e,idx)=>
        e.classList.toggle("active",idx===i)
      );
      const b=state.sentences[state.idx].blocks[i];
      question.textContent=`Funzione logica di "${b.txt}"?`;
      hintBtn.style.display="inline-block";
      hintBtn.disabled=false;
      showOptions(CATS,"cat");
    }

    function showOptions(list,type){
      state.questionType=type;
      optionsDiv.innerHTML="";
      list.forEach(v=>{
        const btn=document.createElement("button");
        btn.textContent=v; btn.className="optionBtn";
        btn.addEventListener("click",()=>answer(v,type));
        optionsDiv.appendChild(btn);
      });
    }

    function answer(val,type){
      const b=state.sentences[state.idx].blocks[state.blockIdx];
      state.attempts++; updateScore();

      if(type==="cat"){
        if(val===b.cat){
          play(true); state.correct++; showFeedback(true);
          if(b.cat==="Complemento"&&b.subcat){
            question.textContent=`Tipo di complemento di "${b.txt}"?`;
            return showOptions(SUBS,"sub");
          }
          markSolved();
        }else{
          play(false); flashError(state.blockIdx); showHint(val,"cat"); showFeedback(false);
        }
      }else if(type==="sub"){
        if(val===b.subcat){
          play(true); state.correct++; showFeedback(true); markSolved();
        }else{
          play(false); flashError(state.blockIdx); showHint(val,"sub"); showFeedback(false);
        }
      }
    }

    /* ------------------------ FEEDBACK & AVANZAMENTO ---------------------- */
    function showUserHint(){
      if(state.blockIdx===null) return;
      const b=state.sentences[state.idx].blocks[state.blockIdx];
      const key = state.questionType==="sub" && b.subcat ? b.subcat : b.cat;
      let html = "<strong>Suggerimento:</strong> ";
      if(LOGIC_DESC[key]){
        html += LOGIC_DESC[key];
      }else{
        html += "Osserva il ruolo che questo frammento svolge rispetto al verbo principale.";
      }
      if(b.cat==="Complemento" && b.subcat && state.questionType==="cat"){
        html += "<br><em>Dopo aver trovato il complemento, indica anche il suo tipo.</em>";
      }
      hintBox.innerHTML=html;
      hintBox.style.display="block";
    }

    function showHint(wrong,type){
      const b=state.sentences[state.idx].blocks[state.blockIdx];
      const correct = type==="cat"?b.cat:b.subcat;
      let html=`<strong>Hai selezionato:</strong> ${wrong}<br>
                <strong>Corretto:</strong> ${correct}<br><br>`;
      if(LOGIC_DESC[correct]) html+=`<em>${LOGIC_DESC[correct]}</em><br>`;
      if(LOGIC_DESC[wrong])   html+=`<em>${LOGIC_DESC[wrong]}</em>`;
      hintBox.innerHTML=html;
      hintBox.style.display="block";
    }

    function markSolved(){
      const el=sentenceArea.children[state.blockIdx];
      el.classList.add("solved"); el.classList.remove("active");
      hintBtn.style.display="none";
      hintBtn.disabled=true;
      const done=[...sentenceArea.children].filter(e=>e.classList.contains("solved")).length;
      progressBar.style.width=`${(done/state.sentences[state.idx].blocks.length)*100}%`;
      checkDone();
    }

    function flashError(idx){
      const el=sentenceArea.children[idx];
      el.classList.add("flash");
      el.addEventListener("animationend",()=>el.classList.remove("flash"),{once:true});
    }

    function checkDone(){
      const all=state.sentences[state.idx].blocks.every((_,i)=>
        sentenceArea.children[i].classList.contains("solved")
      );
      if(all){
        nextBtn.style.display="inline-block";
        clearInterval(state.timerId);
        question.textContent="Frase completata! Punteggio aggiornato.";
      }
    }

    /* --------------------------- NAVIGAZIONE ------------------------------ */
    nextBtn.addEventListener("click",()=>{
      state.idx++;
      if(state.idx>=state.sentences.length){
        alert(`Esercizio completato! Punteggio finale: ${scoreSpan.textContent}/100`);
        loadSentences();
      }
      render();
    });

    changeSentenceBtn.addEventListener("click",()=>{
      state.idx=(state.idx+1)%state.sentences.length;
      render();
    });

    $("modeSel").addEventListener("change",e=>{
      state.mode=e.target.value;
      playerBox.style.display=state.mode==="challenge"?"block":"none";
      render();
    });

    $("levelSel").addEventListener("change",e=>{
      state.level=e.target.value;
      loadSentences(); render();
    });

    hintBtn.addEventListener("click",showUserHint);

    $("readBtn").addEventListener("click",()=>{
      speak(state.sentences[state.idx].text);
    });

    /* ---------------------------- AVVIO ----------------------------------- */
    window.addEventListener("DOMContentLoaded",()=>{
      loadSentences(); render();
    });
  </script>
</body>
</html>
