<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Costruttore di Frase CAA ‚Äì v3.1</title>
  <style>
    :root{ --blue:#4a90e2; --orange:#f39c12; --green:#27ae60;
           --bg:#f0f8ff; --ink:#333; --muted:#fafafa; --card:#fff; --border:#e0e0e0; --panel:#f7fbff; }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:var(--bg);color:var(--ink)}
    .container{max-width:1400px;width:100%;margin:auto;background:#fff;border-radius:16px;padding:28px;box-shadow:0 6px 18px rgba(0,0,0,.08);position:relative}
    .top-panel-toggle{position:absolute;top:16px;right:16px;background:var(--blue);color:#fff;border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,.12);transition:transform .2s;}
    .top-panel-toggle:hover{transform:scale(1.05)}
    .top-panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:18px;display:none;position:relative;top:48px}
    .top-panel.visible{display:block}
    .main-title{text-align:center;font-size:32px;font-weight:800;color:#2c5aa0;margin:0}
    .subtitle{text-align:center;margin:6px 0 0 0;font-size:14px;color:#555}
    .toolbar{display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:14px}
    .toggle{background:var(--muted);border:2px solid var(--border);padding:8px 12px;border-radius:10px;font-size:14px;display:flex;align-items:center;gap:6px}
    .toggle select{margin-left:6px}
    .columns-wrapper{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:22px;margin-top:70px;padding-bottom:6px}
    .column{background:var(--muted);border-radius:14px;padding:16px;border:2px solid var(--border);display:flex;flex-direction:column;min-height:100%}
    .column-title{text-align:center;font-size:18px;font-weight:800;color:#fff;padding:10px;border-radius:10px;margin-bottom:12px}
    .column1 .column-title{background:var(--blue)} .column2 .column-title{background:var(--orange)} .column3 .column-title{background:var(--green)}
    .cards-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;flex:1}
    .card{background:var(--card);border:3px solid #ddd;border-radius:14px;padding:18px;text-align:center;cursor:pointer;user-select:none;transition:transform .15s, box-shadow .15s, border-color .15s; outline:none;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:150px}
    .card:hover{transform:scale(1.02);box-shadow:0 4px 10px rgba(0,0,0,.08)}
    .card.selected{background:#e8f4fd;border-color:var(--blue)}
    .card:focus-visible{box-shadow:0 0 0 3px #2c5aa055}
    .card[aria-disabled="true"]{opacity:.35;pointer-events:none;filter:grayscale(80%)}
    .card-icon{font-size:68px;display:block;margin-bottom:12px}
    .card-label{font-size:20px;font-weight:700;text-transform:lowercase;line-height:1.2}
    .next-step{outline:3px dashed #2c5aa0;outline-offset:6px}
    .phrase-area{margin-top:26px;padding:18px;background:#e8f4fd;border-radius:14px;border:2px solid var(--blue);text-align:center}
    .phrase-area h3{margin:0 0 10px 0}
    .phrase-display{font-size:28px;font-weight:800;min-height:38px;display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap}
    .ok-badge{font-size:22px}
    .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px}
    .btn{padding:10px 16px;border:none;border-radius:10px;font-size:16px;cursor:pointer;color:#fff;display:flex;align-items:center;gap:8px}
    .btn-clear{background:#e74c3c}.btn-clear:hover{filter:brightness(.9)}
    .btn-speak{background:var(--green)} .btn-speak:hover{filter:brightness(.9)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .panel-close{position:absolute;top:12px;right:12px;background:none;border:none;font-size:20px;cursor:pointer;color:#2c5aa0}
    @media (max-width:768px){
      body{padding:10px}
      .container{padding:24px 18px}
      .columns-wrapper{display:flex;flex-direction:column;margin-top:80px}
      .cards-list{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="top-panel-toggle" id="panelToggle" type="button" aria-expanded="false" aria-controls="top-panel" title="Apri impostazioni docente">
      ‚öôÔ∏è
    </button>
    <div class="top-panel" id="top-panel" aria-hidden="true">
      <button class="panel-close" type="button" aria-label="Chiudi impostazioni">‚úï</button>
      <h1 class="main-title">Costruttore di Frase CAA</h1>
      <p class="subtitle">Frase aggiornata ad ogni click. Nessuna combinazione senza senso.</p>

      <div class="toolbar" role="group" aria-label="Impostazioni">
        <label class="toggle">
          <input type="checkbox" id="trainingMode" checked aria-describedby="trainingHelp" />
          <strong>Allenamento</strong>
        </label>
        <span id="trainingHelp" class="sr-only">Quando attivo, la scelta segue l'ordine Chi, Azione, Cosa.</span>
        <label class="toggle">
          <input type="checkbox" id="speakOnClick" checked aria-describedby="speakHelp" />
          <strong>Leggi a ogni click</strong>
        </label>
        <span id="speakHelp" class="sr-only">Quando attivo, il sistema legge ad alta voce la frase parziale.</span>
        <label class="toggle" for="tts-mode">
          <span><strong>Voce</strong></span>
          <select id="tts-mode">
            <option value="browser">Browser (rapida)</option>
            <option value="online">Voce realistica online</option>
          </select>
        </label>
        <label class="toggle" id="voiceSelectWrap" style="display:none">
          <span><strong>Seleziona voce</strong></span>
          <select id="voice-select"></select>
        </label>
      </div>
    </div>

    <div class="columns-wrapper">
      <section class="column column1" role="region" aria-labelledby="tit-subjects">
        <div id="tit-subjects" class="column-title">CHI</div>
        <div class="cards-list" id="subjects">
          <div class="card" data-type="subject" data-word="il bambino" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üë¶</span><span class="card-label">bambino</span></div>
          <div class="card" data-type="subject" data-word="la bambina" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üëß</span><span class="card-label">bambina</span></div>
          <div class="card" data-type="subject" data-word="la mamma" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üë©</span><span class="card-label">mamma</span></div>
          <div class="card" data-type="subject" data-word="il pap√†" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üë®</span><span class="card-label">pap√†</span></div>
          <div class="card" data-type="subject" data-word="il gatto" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üê±</span><span class="card-label">gatto</span></div>
          <div class="card" data-type="subject" data-word="il cane" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üê∂</span><span class="card-label">cane</span></div>
          <div class="card" data-type="subject" data-word="io" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üôã</span><span class="card-label">io</span></div>
        </div>
      </section>

      <section class="column column2" role="region" aria-labelledby="tit-actions">
        <div id="tit-actions" class="column-title">FA</div>
        <div class="cards-list" id="actions">
          <div class="card" data-type="action" data-word="mangia" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üçΩÔ∏è</span><span class="card-label">mangia</span></div>
          <div class="card" data-type="action" data-word="beve" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">ü•§</span><span class="card-label">beve</span></div>
          <div class="card" data-type="action" data-word="gioca" data-prep="con" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üéÆ</span><span class="card-label">gioca</span></div>
          <div class="card" data-type="action" data-word="legge" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üìñ</span><span class="card-label">legge</span></div>
        </div>
      </section>

      <section class="column column3" role="region" aria-labelledby="tit-objects">
        <div id="tit-objects" class="column-title">COSA</div>
        <div class="cards-list" id="objects">
          <div class="card" data-type="object" data-word="la mela" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üçé</span><span class="card-label">mela</span></div>
          <div class="card" data-type="object" data-word="la pizza" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üçï</span><span class="card-label">pizza</span></div>
          <div class="card" data-type="object" data-word="il libro" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üìö</span><span class="card-label">libro</span></div>
          <div class="card" data-type="object" data-word="la palla" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">‚öΩ</span><span class="card-label">palla</span></div>
          <div class="card" data-type="object" data-word="l'acqua" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üíß</span><span class="card-label">acqua</span></div>
          <div class="card" data-type="object" data-word="il latte" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">ü•õ</span><span class="card-label">latte</span></div>
          <div class="card" data-type="object" data-word="il succo" aria-pressed="false" tabindex="0" role="button"><span class="card-icon">üßÉ</span><span class="card-label">succo</span></div>
        </div>
      </section>
    </div>

    <div class="phrase-area" aria-live="polite">
      <h3>La mia frase:</h3>
      <div class="phrase-display" id="phrase-display"><span id="phrase-text">Clicca sulle carte per comporre una frase</span></div>
      <div class="controls">
        <button class="btn btn-speak" id="btn-speak" type="button">üîä Leggi la frase</button>
        <button class="btn btn-clear" id="btn-clear" type="button">üßπ Cancella</button>
      </div>
    </div>
  </div>

  <script>
    const state = { step:'subject', subject:'', action:'', object:'' };

    const actionSpecs = {
      'mangia': { requiresObject:true, objects:['la mela','la pizza'] },
      'beve': { requiresObject:true, objects:["l'acqua",'il latte','il succo'] },
      'legge': { requiresObject:true, objects:['il libro'] },
      'gioca': { requiresObject:true, objects:['la palla'], preposition:'con' }
    };

    const firstPerson = { 'mangia':'mangio','beve':'bevo','gioca':'gioco','legge':'leggo' };

    const subjectObjectBlocks = {
      'il gatto': {
        'mangia': new Set(['la mela'])
      }
    };

    const trainingBox = document.getElementById('trainingMode');
    const speakOnClickBox = document.getElementById('speakOnClick');
    const phraseDisplay = document.getElementById('phrase-display');
    const phraseText = document.getElementById('phrase-text');
    const ttsModeSelect = document.getElementById('tts-mode');
    const voiceSelectWrap = document.getElementById('voiceSelectWrap');
    const voiceSelect = document.getElementById('voice-select');
    const topPanel = document.getElementById('top-panel');
    const panelToggle = document.getElementById('panelToggle');
    const panelClose = topPanel.querySelector('.panel-close');
    let availableVoices = [];
    let currentAudio = null;

    panelToggle.addEventListener('click', () => {
      const isVisible = topPanel.classList.toggle('visible');
      panelToggle.setAttribute('aria-expanded', String(isVisible));
      topPanel.setAttribute('aria-hidden', String(!isVisible));
    });

    panelClose.addEventListener('click', () => {
      topPanel.classList.remove('visible');
      panelToggle.setAttribute('aria-expanded', 'false');
      topPanel.setAttribute('aria-hidden', 'true');
    });

    document.querySelectorAll('.card').forEach(c => {
      c.addEventListener('click', () => onCardClick(c));
      c.addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' '){ e.preventDefault(); c.click(); }});
    });

    document.getElementById('btn-clear').addEventListener('click', clearPhrase);
    document.getElementById('btn-speak').addEventListener('click', speakFullPhrase);
    trainingBox.addEventListener('change', () => highlightStep());
    ttsModeSelect.addEventListener('change', () => {
      const useBrowser = ttsModeSelect.value === 'browser';
      voiceSelectWrap.style.display = useBrowser ? 'flex' : 'none';
      if (!useBrowser && typeof speechSynthesis !== 'undefined') {
        speechSynthesis.cancel();
      }
    });

    initVoices();
    highlightStep();
    enforceFilters();
    updatePhrase();

    function onCardClick(card){
      if (card.getAttribute('aria-disabled') === 'true') return;
      const type = card.dataset.type;
      const word = card.dataset.word;

      if (trainingBox.checked && !isAllowedTypeNow(type)) {
        if (window.navigator.vibrate) navigator.vibrate(30);
        announce('Per favore scegli prima ' + (state.step === 'subject' ? 'CHI' : state.step === 'action' ? 'FA' : 'COSA'));
        return;
      }

      document.querySelectorAll(`.card[data-type="${type}"]`).forEach(c=>{
        c.classList.remove('selected'); c.setAttribute('aria-pressed','false');
      });
      card.classList.add('selected'); card.setAttribute('aria-pressed','true');
      state[type] = word;

      if (type === 'action'){
        const spec = actionSpecs[state.action];
        if (spec){
          if (!spec.requiresObject){
            if (state.object){ deselectObjects(); state.object=''; }
          } else {
            if (state.object && !spec.objects.includes(state.object)){
              deselectObjects(); state.object='';
            }
          }
        }
        if (trainingBox.checked){
          state.step = spec && !spec.requiresObject ? 'done' : 'object';
        }
      } else if (type === 'subject' && trainingBox.checked){
        state.step = 'action';
      }

      enforceFilters();
      ensureValidObjectSelection();
      highlightStep();
      updatePhrase();

      if (speakOnClickBox.checked){
        const partial = currentPhrase(false);
        if (partial) speak(partial);
      }
    }

    function deselectObjects(){
      document.querySelectorAll('.card[data-type="object"]').forEach(o=>{
        o.classList.remove('selected'); o.setAttribute('aria-pressed','false');
      });
    }

    function isAllowedTypeNow(type){
      if (state.step==='done') return false;
      return state.step === type;
    }

    function enforceFilters(){
      const objs = document.querySelectorAll('.card[data-type="object"]');
      const spec = actionSpecs[state.action];
      if (!spec){ objs.forEach(o=>o.setAttribute('aria-disabled','true')); return; }
      if (!spec.requiresObject){
        objs.forEach(o=>o.setAttribute('aria-disabled','true'));
        return;
      }
      objs.forEach(o => {
        const allow = spec.objects.includes(o.dataset.word) && isObjectAllowedForSubject(o.dataset.word);
        o.setAttribute('aria-disabled', allow ? 'false' : 'true');
      });
    }

    function ensureValidObjectSelection(){
      if (!state.object) return;
      if (!isObjectAllowedForSubject(state.object)){
        deselectObjects();
        state.object = '';
      }
    }

    function isObjectAllowedForSubject(objectWord){
      const subject = state.subject;
      const action = state.action;
      if (!subject || !action) return true;
      const blocked = subjectObjectBlocks[subject]?.[action];
      if (!blocked) return true;
      return !blocked.has(objectWord);
    }

    function highlightStep(){
      document.querySelectorAll('.column').forEach(col => col.classList.remove('next-step'));
      if (!trainingBox.checked) return;
      const map = { subject: '.column1', action: '.column2', object: '.column3' };
      const sel = map[state.step] || null;
      if (sel) document.querySelector(sel)?.classList.add('next-step');
    }

    function currentPhrase(includeDot=true){
      const subj = state.subject;
      let verb = state.action;
      const obj  = state.object;
      const spec = actionSpecs[verb] || {};

      if (subj === 'io' && verb){ verb = firstPerson[verb] || verb; }

      if (spec.preposition && obj){
        verb = `${verb} ${spec.preposition}`;
      }

      const parts = [];
      if (subj) parts.push(cap(subj));
      if (verb) parts.push(verb);
      if (spec.requiresObject && obj) parts.push(obj);

      const txt = parts.join(' ');
      if (!txt) return '';
      return includeDot && isPhraseValid() ? `${txt}.` : txt;
    }

    function updatePhrase(){
      const txt = currentPhrase(true) || 'Clicca sulle carte per comporre una frase';
      phraseText.textContent = txt;
      renderOkBadge(isPhraseValid());
    }

    function isPhraseValid(){
      const action = state.action;
      const spec = actionSpecs[action];
      if (!state.subject || !action || !spec) return false;
      if (!spec.requiresObject) return true;
      return !!state.object && spec.objects.includes(state.object) && isObjectAllowedForSubject(state.object);
    }

    function renderOkBadge(valid){
      phraseDisplay.querySelector('.ok-badge')?.remove();
      if (valid){
        const span = document.createElement('span');
        span.className = 'ok-badge';
        span.setAttribute('aria-hidden','true');
        span.textContent = '‚úÖ';
        phraseDisplay.appendChild(span);
      }
    }

    function clearPhrase(){
      Object.assign(state, {step:'subject', subject:'', action:'', object:''});
      document.querySelectorAll('.card').forEach(c=>{
        c.classList.remove('selected'); c.setAttribute('aria-pressed','false'); c.setAttribute('aria-disabled','false');
      });
      enforceFilters();
      highlightStep();
      updatePhrase();
      if (window.navigator.vibrate) navigator.vibrate(10);
    }

    function speakFullPhrase(){
      const txt = currentPhrase(false);
      if (!txt) return;
      speak(txt);
    }

    async function speak(text){
      if (!text) return;
      if (ttsModeSelect.value === 'online'){
        await speakOnline(text);
        return;
      }
      speakLocal(text);
    }

    function speakLocal(text){
      try { speechSynthesis.cancel(); } catch(e){}
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'it-IT';
      utter.rate = 0.95;
      const selectedVoice = voiceSelect.value;
      if (selectedVoice){
        const voice = availableVoices.find(v => v.name === selectedVoice);
        if (voice) utter.voice = voice;
      }
      speechSynthesis.speak(utter);
    }

    async function speakOnline(text){
      try {
        if (currentAudio){
          currentAudio.pause();
          currentAudio = null;
        }
        const response = await fetch(`https://api.streamelements.com/kappa/v2/speech?voice=Carla&text=${encodeURIComponent(text)}`);
        if (!response.ok) throw new Error('Richiesta TTS non riuscita');
        const arrayBuffer = await response.arrayBuffer();
        const blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });
        const objectUrl = URL.createObjectURL(blob);
        const audio = new Audio(objectUrl);
        currentAudio = audio;
        audio.play();
        audio.onended = () => {
          URL.revokeObjectURL(objectUrl);
          currentAudio = null;
        };
      } catch (error) {
        console.error('Errore sintesi online', error);
        speakLocal(text);
      }
    }

    function announce(text){
      if (ttsModeSelect.value === 'online'){
        speakOnline(text);
        return;
      }
      const u = new SpeechSynthesisUtterance(text);
      u.lang='it-IT'; u.rate=1.05;
      try{ speechSynthesis.speak(u);}catch(e){}
    }

    function cap(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

    function initVoices(){
      if (typeof speechSynthesis === 'undefined'){
        voiceSelectWrap.style.display = 'none';
        return;
      }
      const populate = () => {
        availableVoices = speechSynthesis.getVoices().filter(v=>v.lang && v.lang.toLowerCase().startsWith('it'));
        voiceSelect.innerHTML = '';
        availableVoices.forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.name;
          option.textContent = voice.name;
          voiceSelect.appendChild(option);
        });
        if (!availableVoices.length){
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'Nessuna voce italiana disponibile';
          voiceSelect.appendChild(option);
        }
        voiceSelectWrap.style.display = ttsModeSelect.value === 'browser' ? 'flex' : 'none';
      };
      populate();
      speechSynthesis.onvoiceschanged = populate;
    }

    window.addEventListener('beforeunload', () => {
      if (currentAudio){ currentAudio.pause(); }
      if (typeof speechSynthesis !== 'undefined') speechSynthesis.cancel();
    });
  </script>
</body>
</html>
