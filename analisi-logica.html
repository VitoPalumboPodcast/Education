<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Analisi logica ‚Äì CAA (minimale)</title>
<style>
  :root{
    --bg:#f0f8ff; --panel:#f7fbff; --card:#fff; --ink:#0f172a; --muted:#f2f6fc; --border:#d6e3f3;
    --blue:#2c5aa0; --chi:#fbbf24; --fa:#fb7185; --cosa:#34d399;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:960px;margin:auto;padding:16px}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;color:var(--blue);font-size:clamp(18px,3.5vw,26px)}
  .gear{border:none;background:var(--blue);color:#fff;border-radius:999px;width:44px;height:44px;display:grid;place-items:center;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.12)}

  /* Pannello docente (nascosto di default) */
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:10px}
  .panel.hidden{display:none}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .toggle{display:flex;gap:8px;align-items:center;background:var(--muted);border:1px solid var(--border);border-radius:12px;padding:8px 12px}
  select,input[type="range"],button{font-size:16px}

  /* Area studente ‚Äì super minimale */
  .board{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:14px;margin-top:12px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .sentence{font-size:clamp(20px,4.2vw,36px);font-weight:900;text-align:center;margin:6px 8px 10px}
  .question{font-size:clamp(22px,5vw,40px);font-weight:900;text-align:center;margin:6px 8px 14px}

  .tokens{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:6px}
  .card{background:#fff;border:3px solid #e3e7ef;border-radius:14px;min-height:120px;padding:12px;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:10px;cursor:pointer;user-select:none;transition:transform .15s, box-shadow .15s, border-color .15s}
  .card:focus-visible{outline:3px solid #2c5aa055}
  .card:hover{transform:scale(1.02)}
  .card[aria-disabled="true"]{opacity:.35;pointer-events:none;filter:grayscale(80%)}
  .ico{font-size:54px}
  .lbl{font-size:20px;font-weight:900;text-align:center}

  .bins{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
  .bin{background:#fff;border:3px solid var(--border);border-radius:16px;min-height:140px;padding:10px;display:flex;flex-direction:column;gap:8px;align-items:center}
  .bin h3{margin:0;font-size:22px}
  .bin .drop{min-height:74px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center}
  .bin[data-type="fa"]{border-color:var(--fa)}
  .bin[data-type="chi"]{border-color:var(--chi)}
  .bin[data-type="cosa"]{border-color:var(--cosa)}
  .role-badge{font-size:14px;font-weight:900;color:#0f172a;background:#eaf0ff;border:2px solid #cbd5ff;border-radius:999px;padding:2px 8px}
  .chip{background:#fff;border:2px solid #dbe3ef;border-radius:999px;padding:8px 12px;font-weight:900}

  .feedback{min-height:40px;border-radius:12px;padding:8px;font-weight:900;text-align:center}
  .ok{background:color-mix(in srgb, #16a34a 18%, white);color:#064e3b}
  .bad{background:color-mix(in srgb, #dc2626 18%, white);color:#7f1d1d}

  @media print{ .gear,.panel{display:none !important} .board{box-shadow:none} }
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
  <div class="wrap" role="application" aria-describedby="help">
    <header>
      <h1>Analisi logica</h1>
      <button class="gear" id="gear" aria-expanded="false" title="Impostazioni">‚öôÔ∏è</button>
    </header>

    <!-- Pannello docente: tutto ci√≤ che non serve allo studente -->
    <section id="settings" class="panel hidden" aria-label="Impostazioni docente">
      <div class="toolbar" role="group" aria-label="Impostazioni base">
        <label class="toggle"><input type="checkbox" id="training" checked /> <strong>Ordine guidato (CHI ‚Üí FA ‚Üí COSA)</strong></label>
        <label class="toggle"><input type="checkbox" id="speakOnClick" checked /> <strong>Leggi a ogni click</strong></label>
        <label class="toggle"><input type="checkbox" id="speakQuestions" checked /> <strong>Leggi le domande</strong></label>
        <label class="toggle" for="voiceMode"><span><strong>Voce</strong></span>
          <select id="voiceMode"><option value="browser">Browser</option><option value="off">Spento</option></select>
        </label>
        <label class="toggle" for="fontsize">üîé Testo</label>
        <input type="range" id="fontsize" min="90" max="140" value="110" />
      </div>

      <div class="toolbar" role="group" aria-label="Controlli frase">
        <label class="toggle" for="picker"><strong>Frase</strong></label>
        <select id="picker" aria-label="Scegli frase"></select>
        <button class="toggle" id="nextSentence" type="button">‚û°Ô∏è Nuova frase</button>
        <button class="toggle" id="reset" type="button">üîÑ Ricomincia</button>
        <button class="toggle" id="speakSentence" type="button">üîä Leggi frase</button>
        <button class="toggle" id="print" type="button">üñ®Ô∏è Stampa</button>
      </div>
    </section>

    <!-- Area STUDENTE: solo frase, domanda, carte e 3 box -->
    <section class="board" aria-live="polite">
      <div id="sentenceText" class="sentence">La nonna ha preparato il dolce per Luca.</div>
      <div id="question" class="question">Chi ha preparato il dolce?</div>

      <section aria-label="Parole della frase">
        <div class="tokens" id="tokens"></div>
      </section>

      <section class="bins" aria-label="Box di analisi">
        <div class="bin" data-type="chi" aria-label="Soggetto">
          <h3>SOGGETTO <span class="role-badge">(CHI)</span></h3>
          <div class="drop" data-drop="chi"></div>
        </div>
        <div class="bin" data-type="fa" aria-label="Predicato">
          <h3>PREDICATO <span class="role-badge">(FA)</span></h3>
          <div class="drop" data-drop="fa"></div>
        </div>
        <div class="bin" data-type="cosa" aria-label="Complementi">
          <h3 id="compTitle">COMPLEMENTO <span class="role-badge">(COSA)</span></h3>
          <div class="drop" data-drop="cosa"></div>
        </div>
      </section>

      <div id="feedback" class="feedback" role="status"></div>
    </section>
  </div>

<script>
  // ===== Dati (aggiunta informazione grammaticale) =====
  const SENTENCES = [
    { id:'s1',
      label:'La nonna ha preparato il dolce per Luca.',
      grammar:{ subjectNumber:'sing', qChiVerb:'ha preparato', qCompVerb:'ha preparato' },
      tokens:[
        {id:'la-nonna',     label:'La nonna',    role:'chi',  icon:'üëµ'},
        {id:'ha-preparato', label:'ha preparato',role:'fa',   icon:'üç≥'},
        {id:'il-dolce',     label:'il dolce',    role:'cosa', icon:'üç∞', type:'oggetto'},
        {id:'per-luca',     label:'per Luca',    role:'cosa', icon:'üéÅ', type:'termine'}
      ]
    },
    { id:'s2',
      label:'Gli amici organizzano una festa in giardino per Marta.',
      grammar:{ subjectNumber:'plur', qChiVerb:'organizza', qCompVerb:'organizzano' },
      tokens:[
        {id:'gli-amici',    label:'Gli amici',   role:'chi',  icon:'üßíüëß'},
        {id:'organizzano',  label:'organizzano', role:'fa',   icon:'üõ†Ô∏è'},
        {id:'una-festa',    label:'una festa',   role:'cosa', icon:'üéâ', type:'oggetto'},
        {id:'in-giardino',  label:'in giardino', role:'cosa', icon:'üå≥', type:'luogo'},
        {id:'per-marta',    label:'per Marta',   role:'cosa', icon:'üéÅ', type:'termine'}
      ]
    }
  ];

  // flusso: CHI ‚Üí FA ‚Üí COSA (pi√π complementi nello stesso step)
  const ORDER = ['chi','fa','cosa'];

  // ===== Stato =====
  let current = SENTENCES[0];
  let stepIndex = 0; // 0=CHI
  const placedIds = new Set();

  // ===== Elementi =====
  const gear = document.getElementById('gear');
  const settings = document.getElementById('settings');
  const training = document.getElementById('training');
  const speakOnClick = document.getElementById('speakOnClick');
  const speakQuestions = document.getElementById('speakQuestions');
  const voiceMode = document.getElementById('voiceMode');
  const fontsize = document.getElementById('fontsize');
  const picker = document.getElementById('picker');
  const sentenceText = document.getElementById('sentenceText');
  const questionEl = document.getElementById('question');
  const tokensEl = document.getElementById('tokens');
  const drops = {
    chi:  document.querySelector('[data-drop="chi"]'),
    fa:   document.querySelector('[data-drop="fa"]'),
    cosa: document.querySelector('[data-drop="cosa"]')
  };
  const feedback = document.getElementById('feedback');

  // ===== UI base =====
  gear.addEventListener('click',()=>{ const hidden=settings.classList.toggle('hidden'); gear.setAttribute('aria-expanded', String(!hidden)); });
  document.getElementById('print').addEventListener('click', ()=>window.print());
  document.getElementById('reset').addEventListener('click', ()=>loadSentence(current.id));
  document.getElementById('speakSentence').addEventListener('click', ()=>tts(current.label));
  fontsize.addEventListener('input', ()=>{ document.body.style.fontSize = fontsize.value+'%'; });
  document.getElementById('nextSentence').addEventListener('click',()=>{ const i=(SENTENCES.findIndex(s=>s.id===current.id)+1)%SENTENCES.length; loadSentence(SENTENCES[i].id); });
  picker.addEventListener('change', e=>loadSentence(e.target.value));

  // ===== Render =====
  function renderPicker(){
    picker.innerHTML='';
    for(const s of SENTENCES){ const o=document.createElement('option'); o.value=s.id; o.textContent=s.label; picker.appendChild(o); }
  }

  function renderTokens(){
    tokensEl.innerHTML='';
    for(const tok of current.tokens){
      const c=document.createElement('button');
      c.type='button'; c.className='card'; c.dataset.id=tok.id; c.dataset.role=tok.role;
      c.innerHTML=`<span class="ico" aria-hidden="true">${tok.icon||'üî∑'}</span><span class="lbl">${tok.label}</span>`;
      c.addEventListener('click',()=>onTokenClick(tok, c));
      c.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); c.click(); } });
      c.draggable=true; c.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', JSON.stringify({id:tok.id})); });
      tokensEl.appendChild(c);
    }
  }

  // Drop zone handlers (supporto anche al drag)
  Object.entries(drops).forEach(([role,el])=>{
    el.addEventListener('dragover', e=>e.preventDefault());
    el.addEventListener('drop', e=>{ e.preventDefault(); try{ const data=JSON.parse(e.dataTransfer.getData('text/plain')); const tok=current.tokens.find(t=>t.id===data.id); if(tok) placeToken(tok, el); }catch(_){ } });
  });

  // ===== Helpers =====
  const subjToken = () => current.tokens.find(t=>t.role==='chi');
  const verbToken = () => current.tokens.find(t=>t.role==='fa');
  const objectToken = () => current.tokens.find(t=>t.type==='oggetto');
  const luogoToken  = () => current.tokens.find(t=>t.type==='luogo');
  const termineToken= () => current.tokens.find(t=>t.type==='termine');

  const isPlaced = (id)=> placedIds.has(id);

  function nextUnplacedComplementType(){
    const order=['oggetto','luogo','termine'];
    for(const tp of order){
      const tok = current.tokens.find(t=>t.type===tp);
      if(tok && !isPlaced(tok.id)) return tp;
    }
    return null;
  }

  function auxFa(){ return current.grammar.subjectNumber==='plur' ? 'fanno' : 'fa'; }

  // ===== Domanda mirata dinamica (corretta) =====
  function buildQuestion(){
    const sub = getPlaced('chi') || subjToken()?.label; // per "fa" usiamo il soggetto se gi√† noto
    const vChi = current.grammar.qChiVerb;   // per la domanda "Chi ...?" (es. "Chi organizza ...?", "Chi ha preparato ...?")
    const vComp = current.grammar.qCompVerb; // per domande su oggetto/luogo/termine (es. "dove organizzano...", "per chi ha preparato...")
    const obj = objectToken()?.label;

    const step = ORDER[stepIndex];
    if(step==='chi'){
      // es.: "Chi ha preparato il dolce?" / "Chi organizza la festa?"
      const piece = obj ? ` ${obj}` : '';
      return `Chi ${vChi}${piece}?`;
    }
    if(step==='fa'){
      // es.: "Che cosa fa la nonna?" / "Che cosa fanno gli amici?"
      return sub ? `Che cosa ${auxFa()} ${lowerFirst(sub)}?` : 'Che cosa fa?';
    }
    // step = 'cosa' ‚Üí domande specifiche per ciascun complemento non ancora scelto
    const nextType = nextUnplacedComplementType();
    if(nextType==='oggetto'){
      // es.: "Che cosa ha preparato la nonna?" / "Che cosa organizzano gli amici?"
      return sub ? `Che cosa ${vComp} ${lowerFirst(sub)}?` : `Che cosa ${vComp}?`;
    }
    if(nextType==='luogo'){
      // es.: "Dove organizzano la festa?" (preferisci usare l'oggetto se presente)
      if(obj) return `Dove ${vComp} ${obj}?`;
      return sub ? `Dove ${vComp} ${lowerFirst(sub)}?` : `Dove ${vComp}?`;
    }
    if(nextType==='termine'){
      // es.: "Per chi ha preparato il dolce?" / "Per chi organizzano la festa?"
      if(obj) return `Per chi ${vComp} ${obj}?`;
      return sub ? `Per chi ${vComp} ${lowerFirst(sub)}?` : `Per chi ${vComp}?`;
    }
    // Tutti i complementi selezionati ‚Üí domanda finale neutra (opzionale)
    return 'Hai completato la frase!';
  }

  function lowerFirst(str){ return str ? str.charAt(0).toLowerCase()+str.slice(1) : str; }
  function updateQuestion(){
    const q = buildQuestion();
    questionEl.textContent = q;
    updateComplementTitle();
    if(speakQuestions && speakQuestions.checked) tts(q);
  }
  function getPlaced(role){ const el=drops[role]; const chip=el.querySelector('.chip'); return chip? chip.textContent : ''; }

  // ===== Logica click =====
  function onTokenClick(tok, card){
    const expected = ORDER[stepIndex];
    if(training.checked && tok.role!==expected){
      // Durante i complementi, restiamo sempre su 'cosa' finch√© non sono finiti
      if(!(expected==='cosa' && tok.role==='cosa')){
        vibrate(30); flash(card); setFeedback('Rispondi alla domanda grande al centro.', 'bad'); return;
      }
    }
    placeToken(tok, drops[tok.role]);
  }

  function placeToken(tok, targetDrop){
    if(targetDrop.getAttribute('data-drop')!==tok.role){ setFeedback('Non qui.', 'bad'); vibrate(20); return; }
    const btn = tokensEl.querySelector(`[data-id="${tok.id}"]`); if(!btn) return;
    btn.setAttribute('aria-disabled','true'); btn.draggable=false; placedIds.add(tok.id);
    const chip=document.createElement('span'); chip.className='chip'; chip.textContent=tok.label; targetDrop.appendChild(chip);
    if(speakOnClick.checked) tts(tok.label);

    // Avanza step: chi ‚Üí fa ‚Üí cosa; per i complementi restiamo su 'cosa' finch√© non terminano
    if(tok.role!=='cosa' && stepIndex < ORDER.length-1){ stepIndex++; }
    else if(tok.role==='cosa'){
      if(!nextUnplacedComplementType()){
        setFeedback('Bravo! Analisi completata.', 'ok');
      }
    }
    updateComplementTitle();
    updateQuestion();
    if(tok.role!=='cosa') setFeedback('Bravo!', 'ok');
  }

  function setFeedback(msg, type){ feedback.textContent=msg||''; feedback.className='feedback '+(type||''); }
  function flash(el){ el.animate([{transform:'scale(1)'},{transform:'scale(1.03)'},{transform:'scale(1)'}], {duration:220}); }
  function vibrate(ms){ if(navigator.vibrate) navigator.vibrate(ms); }

  // ===== TTS =====
  function tts(text){ if(!text||voiceMode.value==='off') return; try{ speechSynthesis.cancel(); }catch(_){ }
    const u=new SpeechSynthesisUtterance(text); u.lang='it-IT'; u.rate=0.95; try{ speechSynthesis.speak(u); }catch(_){ }
  }

  // ===== Caricamento frase =====
  function clearBins(){ Object.values(drops).forEach(d=>d.innerHTML=''); placedIds.clear(); }

  function loadSentence(id){
    const s = SENTENCES.find(x=>x.id===id) || SENTENCES[0];
    current=s; if(picker) picker.value=s.id; stepIndex=0; setFeedback('', '');
    sentenceText.textContent = s.label; clearBins(); renderTokens(); updateQuestion(); updateComplementTitle();
  }

  // ===== Avvio =====
  renderPicker();
  loadSentence(SENTENCES[0].id);

  // Titolo dinamico del box complementi
  function updateComplementTitle(){
    const h = document.getElementById('compTitle');
    if(!h) return;
    if(ORDER[stepIndex] !== 'cosa'){
      h.innerHTML = 'COMPLEMENTO <span class="role-badge">(COSA)</span>';
      return;
    }
    const tp = nextUnplacedComplementType();
    if(tp==='oggetto')      h.innerHTML = 'COMPLEMENTO <span class="role-badge">(COSA)</span>';
    else if(tp==='luogo')   h.innerHTML = 'COMPLEMENTO <span class="role-badge">(LUOGO)</span>';
    else if(tp==='termine') h.innerHTML = 'COMPLEMENTO <span class="role-badge">(TERMINE)</span>';
    else                    h.innerHTML = 'COMPLEMENTI <span class="role-badge">(COMPLETATO)</span>';
  }

  // ===== Sanity tests (non invasivi, solo console) =====
  try {
    console.assert(Array.isArray(SENTENCES) && SENTENCES.length >= 2, 'SENTENCES non valido');
    console.assert(ORDER.join(',') === 'chi,fa,cosa', 'ORDER non valido');
    console.assert(typeof buildQuestion === 'function', 'buildQuestion mancante');
    console.assert(nextUnplacedComplementType() === 'oggetto', 'Atteso oggetto come primo complemento');
    console.log('[OK] Sanity checks passed');
  } catch (e) {
    console.error('[ERR] Sanity checks failed', e);
  }
</script>
</body>
</html>
