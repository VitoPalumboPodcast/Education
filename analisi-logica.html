<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analisi logica ‚Äì Chi ‚Ä¢ Fa ‚Ä¢ Cosa</title>
  <style>
    :root {
      --base-font-size: 20px;
      --bg: #f0f8ff;
      --panel: #ffffff;
      --ink: #0f172a;
      --muted: #e6efff;
      --card: #ffffff;
      --border: #c7d7ee;
      --shadow: 0 10px 28px rgba(15, 23, 42, 0.1);
      --chi: #4f46e5;
      --fa: #fb923c;
      --cosa: #22c55e;
      --feedback-ok: #0f766e;
      --feedback-ko: #b91c1c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Atkinson Hyperlegible", Arial, sans-serif;
      font-size: var(--base-font-size);
      background: var(--bg);
      color: var(--ink);
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    body.high-contrast {
      --bg: #0f172a;
      --panel: #111827;
      --ink: #f8fafc;
      --muted: #1f2937;
      --card: #1f2937;
      --border: #334155;
      --shadow: none;
    }

    .app {
      width: min(980px, 100%);
      background: var(--panel);
      border-radius: 24px;
      padding: 24px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.3rem, 3vw, 1.8rem);
      line-height: 1.1;
      color: var(--chi);
    }

    .gear {
      border: none;
      background: var(--chi);
      color: #ffffff;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: grid;
      place-items: center;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.25);
      transition: transform 0.2s ease;
    }

    .gear:hover,
    .gear:focus-visible {
      transform: scale(1.05);
      outline: none;
    }

    .sentence {
      background: var(--muted);
      padding: 16px;
      border-radius: 20px;
      font-weight: 800;
      text-align: center;
      font-size: clamp(1.2rem, 4vw, 1.8rem);
    }

    .mode-hint {
      margin: 0;
      text-align: center;
      font-size: 0.95em;
      color: rgba(15, 23, 42, 0.7);
    }

    body.high-contrast .mode-hint {
      color: #cbd5f5;
    }

    .step-indicator {
      display: flex;
      gap: 12px;
    }

    .step {
      flex: 1;
      padding: 12px;
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.06);
      text-align: center;
      font-weight: 700;
      opacity: 0.6;
      transition: opacity 0.2s, transform 0.2s;
    }

    .step.active {
      opacity: 1;
      transform: scale(1.02);
    }

    .step.done {
      background: rgba(79, 70, 229, 0.18);
    }

    .question {
      font-size: clamp(1.1rem, 3.6vw, 1.6rem);
      font-weight: 800;
      text-align: center;
      margin: 4px 0 12px;
    }

    .workspace {
      display: grid;
      gap: 16px;
    }

    .word-bank {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    .token {
      padding: 14px 18px;
      border-radius: 18px;
      background: var(--card);
      border: 3px solid transparent;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s, border-color 0.2s, background 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 104px;
      min-height: 104px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
    }

    .token:focus-visible {
      outline: 3px solid rgba(79, 70, 229, 0.45);
    }

    .token:active {
      transform: scale(0.96);
    }

    .token.locked {
      opacity: 0.45;
      pointer-events: none;
      box-shadow: none;
    }

    .token[data-role="chi"] { border-color: rgba(79, 70, 229, 0.35); }
    .token[data-role="fa"] { border-color: rgba(251, 146, 60, 0.4); }
    .token[data-role="cosa"] { border-color: rgba(34, 197, 94, 0.4); }

    .token-icon {
      font-size: 2.6em;
      line-height: 1;
    }

    .token-label {
      font-size: 1em;
      line-height: 1.1;
      text-align: center;
    }

    .bins {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
    }

    .bin {
      background: var(--card);
      border-radius: 22px;
      padding: 16px;
      border: 5px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 170px;
      transition: border-color 0.2s, transform 0.2s;
    }

    .bin[data-role="chi"] { border-color: rgba(79, 70, 229, 0.45); }
    .bin[data-role="fa"] { border-color: rgba(251, 146, 60, 0.55); }
    .bin[data-role="cosa"] { border-color: rgba(34, 197, 94, 0.55); }

    .bin.active {
      transform: scale(1.01);
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.15);
    }

    .bin h3 {
      margin: 0;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .role-badge {
      font-size: 0.7em;
      font-weight: 800;
      background: rgba(15, 23, 42, 0.08);
      padding: 4px 8px;
      border-radius: 999px;
    }

    .drop {
      min-height: 88px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }

    .chip {
      background: var(--muted);
      border: 2px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 800;
      font-size: 0.95em;
    }

    .feedback {
      min-height: 40px;
      text-align: center;
      font-weight: 800;
      border-radius: 12px;
      padding: 10px 14px;
    }

    .feedback.ok {
      background: rgba(34, 197, 94, 0.15);
      color: var(--feedback-ok);
    }

    .feedback.bad {
      background: rgba(239, 68, 68, 0.16);
      color: var(--feedback-ko);
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .controls button {
      border: none;
      border-radius: 14px;
      padding: 10px 16px;
      font-size: 1em;
      font-weight: 700;
      cursor: pointer;
      background: var(--chi);
      color: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .controls button.secondary {
      background: var(--fa);
      color: #1f1729;
    }

    .panel {
      position: absolute;
      right: 24px;
      top: 72px;
      background: var(--panel);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 18px;
      width: min(320px, 80vw);
      border: 2px solid rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 14px;
      z-index: 10;
    }

    .panel.hidden {
      display: none;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .toggle {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      background: var(--muted);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 12px;
      font-size: 0.85em;
      font-weight: 700;
    }

    .toggle input,
    .toggle select {
      font-size: 1em;
    }

    input[type="range"] {
      width: 140px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 720px) {
      body {
        padding: 16px;
      }

      .app {
        padding: 18px;
      }

      .step-indicator {
        flex-direction: column;
      }
    }

    @media print {
      body {
        padding: 0;
        background: #ffffff;
      }

      .app {
        box-shadow: none;
        border-radius: 0;
      }

      .gear,
      .panel,
      .controls,
      .mode-hint,
      .feedback {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-describedby="question">
    <header>
      <h1>Analisi logica: Chi ‚Üí Fa ‚Üí Cosa</h1>
      <button class="gear" id="gear" aria-expanded="false" aria-controls="settings" title="Impostazioni docente">‚öôÔ∏è</button>
    </header>

    <section class="sentence" id="sentenceText" aria-live="polite"></section>
    <p class="mode-hint" id="modeHint" role="status" aria-live="polite"></p>

    <div class="step-indicator" aria-hidden="true">
      <div class="step" data-role="chi">1. üßë‚Äçü§ù‚Äçüßë Trova CHI</div>
      <div class="step" data-role="fa">2. ‚ö° Trova FA (verbo)</div>
      <div class="step" data-role="cosa">3. üß© Completa con COSA</div>
    </div>

    <div id="question" class="question" aria-live="polite"></div>

    <div class="workspace">
      <section aria-label="Parole della frase" class="word-bank" id="tokens"></section>

      <section class="bins" aria-label="Cestini dell'analisi">
        <div class="bin" data-role="chi">
          <h3>CHI <span class="role-badge">Soggetto</span></h3>
          <div class="drop" data-drop="chi"></div>
        </div>
        <div class="bin" data-role="fa">
          <h3>FA <span class="role-badge">Predicato</span></h3>
          <div class="drop" data-drop="fa"></div>
        </div>
        <div class="bin" data-role="cosa">
          <h3 id="compTitle">COSA <span class="role-badge">Complemento</span></h3>
          <div class="drop" data-drop="cosa"></div>
        </div>
      </section>
    </div>

    <div id="feedback" class="feedback" role="status"></div>

    <div class="controls">
      <button id="reset" type="button">‚Ü∫ Ricomincia</button>
      <button class="secondary" id="nextSentence" type="button">‚û°Ô∏è Frase nuova</button>
      <button id="speakSentence" type="button">üîä Leggi frase</button>
      <button id="print" type="button">üñ®Ô∏è Stampa</button>
    </div>
  </div>

  <section id="settings" class="panel hidden" aria-label="Impostazioni docente">
    <div class="toolbar" role="group" aria-label="Impostazioni guida">
      <label class="toggle"><input type="checkbox" id="training" checked /> <strong>Ordine guidato</strong></label>
      <label class="toggle"><input type="checkbox" id="speakOnClick" checked /> <strong>Leggi a ogni click</strong></label>
      <label class="toggle"><input type="checkbox" id="speakQuestions" /> <strong>Leggi le domande</strong></label>
      <label class="toggle"><input type="checkbox" id="contrastToggle" /> <strong>Contrasto alto</strong></label>
    </div>
    <div class="toolbar" role="group" aria-label="Voce e testo">
      <label class="toggle" for="voiceMode"><span><strong>Voce</strong></span>
        <select id="voiceMode">
          <option value="browser">Browser</option>
          <option value="off">Spento</option>
        </select>
      </label>
      <label class="toggle" for="fontsize">üîé Testo</label>
      <input type="range" id="fontsize" min="90" max="140" value="110" aria-label="Dimensione testo" />
    </div>
    <div class="toolbar" role="group" aria-label="Controllo frase">
      <label class="toggle" for="picker"><strong>Frase</strong></label>
      <select id="picker" aria-label="Scegli la frase"></select>
    </div>
  </section>

  <script>
    const SENTENCES = [
      {
        id: 's1',
        label: 'La nonna ha preparato il dolce per Luca.',
        grammar: { subjectNumber: 'sing', qChiVerb: 'ha preparato', qCompVerb: 'ha preparato' },
        tokens: [
          { id: 'la-nonna', label: 'La nonna', role: 'chi', icon: 'üëµ' },
          { id: 'ha-preparato', label: 'ha preparato', role: 'fa', icon: 'üç≥' },
          { id: 'il-dolce', label: 'il dolce', role: 'cosa', icon: 'üç∞', type: 'oggetto' },
          { id: 'per-luca', label: 'per Luca', role: 'cosa', icon: 'üéÅ', type: 'termine' }
        ]
      },
      {
        id: 's2',
        label: 'Gli amici organizzano una festa in giardino per Marta.',
        grammar: { subjectNumber: 'plur', qChiVerb: 'organizza', qCompVerb: 'organizzano' },
        tokens: [
          { id: 'gli-amici', label: 'Gli amici', role: 'chi', icon: 'üßë‚Äçü§ù‚Äçüßë' },
          { id: 'organizzano', label: 'organizzano', role: 'fa', icon: 'üõ†Ô∏è' },
          { id: 'una-festa', label: 'una festa', role: 'cosa', icon: 'üéâ', type: 'oggetto' },
          { id: 'in-giardino', label: 'in giardino', role: 'cosa', icon: 'üå≥', type: 'luogo' },
          { id: 'per-marta', label: 'per Marta', role: 'cosa', icon: 'üéÅ', type: 'termine' }
        ]
      },
      {
        id: 's3',
        label: 'Marco legge un libro interessante alla sorella.',
        grammar: { subjectNumber: 'sing', qChiVerb: 'legge', qCompVerb: 'legge' },
        tokens: [
          { id: 'marco', label: 'Marco', role: 'chi', icon: 'üë¶' },
          { id: 'legge', label: 'legge', role: 'fa', icon: 'üìñ' },
          { id: 'un-libro', label: 'un libro', role: 'cosa', icon: 'üìö', type: 'oggetto' },
          { id: 'interessante', label: 'interessante', role: 'cosa', icon: 'üí°', type: 'qualita' },
          { id: 'alla-sorella', label: 'alla sorella', role: 'cosa', icon: 'üëß', type: 'termine' }
        ]
      }
    ];

    const ORDER = ['chi', 'fa', 'cosa'];

    const steps = Array.from(document.querySelectorAll('.step'));
    const bins = ORDER.map(role => document.querySelector(`.bin[data-role="${role}"]`));
    const drops = {
      chi: document.querySelector('[data-drop="chi"]'),
      fa: document.querySelector('[data-drop="fa"]'),
      cosa: document.querySelector('[data-drop="cosa"]')
    };

    const sentenceText = document.getElementById('sentenceText');
    const questionEl = document.getElementById('question');
    const modeHint = document.getElementById('modeHint');
    const feedback = document.getElementById('feedback');
    const tokensEl = document.getElementById('tokens');

    const gear = document.getElementById('gear');
    const settings = document.getElementById('settings');
    const training = document.getElementById('training');
    const speakOnClick = document.getElementById('speakOnClick');
    const speakQuestions = document.getElementById('speakQuestions');
    const contrastToggle = document.getElementById('contrastToggle');
    const voiceMode = document.getElementById('voiceMode');
    const fontsize = document.getElementById('fontsize');
    const picker = document.getElementById('picker');

    const resetButton = document.getElementById('reset');
    const nextButton = document.getElementById('nextSentence');
    const speakSentenceButton = document.getElementById('speakSentence');
    const printButton = document.getElementById('print');

    const ROLE_MESSAGES = {
      chi: 'Ottimo! Hai individuato il CHI.',
      fa: 'Bravo! Hai trovato il FA (verbo).',
      cosa: 'Ben fatto! Hai aggiunto un complemento.'
    };

    const ERROR_MESSAGES = {
      chi: 'Per prima cosa trova chi compie l\'azione.',
      fa: 'Ora individua il verbo (FA).',
      cosa: 'Completa con i complementi della frase.'
    };

    const STEP_HINTS = {
      chi: 'Trova chi compie l\'azione descritta.',
      fa: 'Cerca nella frase il FA: il verbo dell\'azione.',
      cosa: 'Trascina gli altri pezzi nel cestino dei complementi.'
    };

    let current = SENTENCES[0];
    let stepIndex = 0;
    const placedIds = new Set();
    let draggedId = null;

    function renderPicker() {
      picker.innerHTML = '';
      for (const sentence of SENTENCES) {
        const option = document.createElement('option');
        option.value = sentence.id;
        option.textContent = sentence.label;
        picker.appendChild(option);
      }
    }

    function renderTokens() {
      tokensEl.innerHTML = '';
      current.tokens.forEach(tokenData => {
        const token = document.createElement('button');
        token.type = 'button';
        token.className = 'token';
        token.dataset.id = tokenData.id;
        token.dataset.role = tokenData.role;
        token.draggable = true;

        const iconSpan = document.createElement('span');
        iconSpan.className = 'token-icon';
        iconSpan.textContent = tokenData.icon || roleFallback(tokenData.role);
        iconSpan.setAttribute('aria-hidden', 'true');
        token.appendChild(iconSpan);

        const labelSpan = document.createElement('span');
        labelSpan.className = 'token-label';
        labelSpan.textContent = tokenData.label;
        token.appendChild(labelSpan);

        token.addEventListener('click', () => tryPlaceToken(tokenData));
        token.addEventListener('dragstart', event => {
          draggedId = tokenData.id;
          event.dataTransfer.effectAllowed = 'move';
        });
        token.addEventListener('dragend', () => {
          draggedId = null;
        });

        tokensEl.appendChild(token);
      });
    }

    function roleFallback(role) {
      if (role === 'chi') return 'üßë‚Äçü§ù‚Äçüßë';
      if (role === 'fa') return '‚ö°';
      return 'üß©';
    }

    function isPlaced(id) {
      return placedIds.has(id);
    }

    function dropToken(tokenData, role) {
      const drop = drops[role];
      if (!drop) return;
      const button = tokensEl.querySelector(`[data-id="${tokenData.id}"]`);
      if (!button) return;
      button.classList.add('locked');
      button.setAttribute('aria-disabled', 'true');
      button.draggable = false;
      placedIds.add(tokenData.id);

      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.dataset.role = role;
      chip.textContent = tokenData.label;
      drop.appendChild(chip);

      if (speakOnClick.checked) {
        tts(tokenData.label);
      }

      if (training.checked) {
        if (role !== 'cosa' && stepIndex < ORDER.length - 1) {
          stepIndex += 1;
        } else if (role === 'cosa' && !nextUnplacedComplementType()) {
          stepIndex = ORDER.length - 1;
        }
      }

      syncGuidedUI();
      updateComplementTitle();
      updateQuestion();
      updateModeHint();

      if (isSentenceComplete()) {
        setFeedback('Bravo! Analisi completata.', 'ok');
      } else {
        setFeedback(ROLE_MESSAGES[role] || 'Ben fatto!', 'ok');
      }
    }

    function tryPlaceToken(tokenData) {
      if (isPlaced(tokenData.id)) {
        return;
      }

      const expected = ORDER[stepIndex];
      const drop = drops[tokenData.role];
      if (!drop) return;

      if (training.checked) {
        if (expected !== tokenData.role && !(expected === 'cosa' && tokenData.role === 'cosa')) {
          flash(bins[stepIndex]);
          vibrate(30);
          setFeedback(ERROR_MESSAGES[expected] || 'Segui l\'ordine guidato.', 'bad');
          return;
        }
      }

      dropToken(tokenData, tokenData.role);
      checkCompletion();
    }

    function handleDrop(event, role) {
      event.preventDefault();
      if (!draggedId) return;
      const tokenData = current.tokens.find(tok => tok.id === draggedId);
      if (!tokenData || isPlaced(tokenData.id)) return;

      if (role !== tokenData.role) {
        setFeedback(`In questo cestino vanno elementi di tipo ${role.toUpperCase()}.`, 'bad');
        vibrate(20);
        return;
      }

      if (training.checked) {
        const expected = ORDER[stepIndex];
        if (expected !== role && !(expected === 'cosa' && role === 'cosa')) {
          flash(bins[stepIndex]);
          setFeedback(ERROR_MESSAGES[expected] || 'Segui l\'ordine guidato.', 'bad');
          vibrate(30);
          return;
        }
      }

      dropToken(tokenData, role);
      checkCompletion();
    }

    function checkCompletion() {
      if (!isSentenceComplete()) return;
      setFeedback('Bravo! Analisi completata.', 'ok');
      modeHint.textContent = 'Frase completata! Ottimo lavoro.';
    }

    function isSentenceComplete() {
      return placedIds.size === current.tokens.length;
    }

    function resetSentence() {
      placedIds.clear();
      draggedId = null;
      Object.values(drops).forEach(drop => {
        drop.innerHTML = '';
      });
      Array.from(tokensEl.children).forEach(btn => {
        btn.classList.remove('locked');
        btn.removeAttribute('aria-disabled');
        btn.draggable = true;
      });
      stepIndex = 0;
      syncGuidedUI();
      updateComplementTitle();
      updateQuestion();
      updateModeHint();
      setFeedback('', '');
    }

    function loadSentence(id) {
      const next = SENTENCES.find(sentence => sentence.id === id) || SENTENCES[0];
      current = next;
      picker.value = next.id;
      sentenceText.textContent = next.label;
      renderTokens();
      resetSentence();
    }

    function syncGuidedUI() {
      if (!training.checked) {
        steps.forEach(step => step.classList.remove('active', 'done'));
        bins.forEach(bin => bin.classList.remove('active'));
        return;
      }

      steps.forEach((step, index) => {
        step.classList.toggle('active', index === stepIndex);
        step.classList.toggle('done', index < stepIndex);
      });
      bins.forEach((bin, index) => {
        bin.classList.toggle('active', index === stepIndex);
      });
    }

    function updateModeHint() {
      if (!modeHint) return;
      if (isSentenceComplete()) {
        modeHint.textContent = 'Frase completata! Ottimo lavoro.';
        return;
      }

      if (!training.checked) {
        const remaining = current.tokens.length - placedIds.size;
        modeHint.textContent = remaining > 0
          ? `Modalit√† libera: abbina le parole ai cestini corretti (ne mancano ${remaining}).`
          : 'Modalit√† libera: tutti i pezzi sono al posto giusto!';
        return;
      }

      const role = ORDER[stepIndex];
      modeHint.textContent = STEP_HINTS[role] || 'Segui l\'ordine guidato.';
    }

    function getPlaced(role) {
      const drop = drops[role];
      if (!drop) return '';
      const chip = drop.querySelector('.chip');
      return chip ? chip.textContent : '';
    }

    function nextUnplacedComplementType() {
      const order = ['oggetto', 'luogo', 'termine', 'qualita'];
      for (const type of order) {
        const token = current.tokens.find(tok => tok.type === type);
        if (token && !placedIds.has(token.id)) {
          return type;
        }
      }
      return null;
    }

    function subjToken() {
      return current.tokens.find(tok => tok.role === 'chi');
    }

    function objectToken() {
      return current.tokens.find(tok => tok.type === 'oggetto');
    }

    function lowerFirst(str) {
      return str ? str.charAt(0).toLowerCase() + str.slice(1) : str;
    }

    function auxFa() {
      return current.grammar?.subjectNumber === 'plur' ? 'fanno' : 'fa';
    }

    function buildQuestion() {
      const progressIndex = training.checked ? stepIndex : computeStepFromProgress(true);
      const stepRole = ORDER[progressIndex];
      const subject = getPlaced('chi') || subjToken()?.label;
      const obj = objectToken()?.label;
      const verbChi = current.grammar?.qChiVerb || 'fa';
      const verbComp = current.grammar?.qCompVerb || 'fa';

      if (stepRole === 'chi') {
        const piece = obj ? ` ${obj}` : '';
        return `Chi ${verbChi}${piece}?`;
      }

      if (stepRole === 'fa') {
        return subject ? `Che cosa ${auxFa()} ${lowerFirst(subject)}?` : 'Che cosa fa?';
      }

      const nextComplement = nextUnplacedComplementType();
      if (nextComplement === 'oggetto') {
        return subject ? `Che cosa ${verbComp} ${lowerFirst(subject)}?` : `Che cosa ${verbComp}?`;
      }
      if (nextComplement === 'luogo') {
        if (obj) return `Dove ${verbComp} ${lowerFirst(obj)}?`;
        return subject ? `Dove ${verbComp} ${lowerFirst(subject)}?` : `Dove ${verbComp}?`;
      }
      if (nextComplement === 'termine') {
        if (obj) return `Per chi ${verbComp} ${lowerFirst(obj)}?`;
        return subject ? `Per chi ${verbComp} ${lowerFirst(subject)}?` : `Per chi ${verbComp}?`;
      }
      if (nextComplement === 'qualita') {
        return 'Come √® questo elemento della frase?';
      }
      return 'Hai completato la frase!';
    }

    function updateQuestion() {
      const question = buildQuestion();
      questionEl.textContent = question;
      if (speakQuestions.checked) {
        tts(question);
      }
    }

    function updateComplementTitle() {
      const title = document.getElementById('compTitle');
      if (!title) return;
      const type = nextUnplacedComplementType();
      if (!training.checked || !type) {
        title.innerHTML = 'COSA <span class="role-badge">Complemento</span>';
        if (!type && isSentenceComplete()) {
          title.innerHTML = 'COMPLEMENTI <span class="role-badge">Completo</span>';
        }
        return;
      }
      const labels = {
        oggetto: 'Complemento Oggetto',
        luogo: 'Complemento di Luogo',
        termine: 'Complemento di Termine',
        qualita: 'Espansione'
      };
      title.innerHTML = `${labels[type] || 'Complemento'} <span class="role-badge">(COSA)</span>`;
    }

    function setFeedback(message, kind) {
      feedback.textContent = message || '';
      feedback.className = 'feedback';
      if (kind) {
        feedback.classList.add(kind);
      }
      if (kind === 'bad') {
        feedback.setAttribute('role', 'alert');
        setTimeout(() => feedback.removeAttribute('role'), 600);
      } else if (message) {
        feedback.setAttribute('role', 'status');
      } else {
        feedback.removeAttribute('role');
      }
    }

    function flash(el) {
      if (!el || typeof el.animate !== 'function') return;
      el.animate([
        { transform: 'scale(1)' },
        { transform: 'scale(1.03)' },
        { transform: 'scale(1)' }
      ], { duration: 220 });
    }

    function vibrate(ms) {
      if (navigator.vibrate) navigator.vibrate(ms);
    }

    function tts(text) {
      if (!text || voiceMode.value === 'off' || typeof speechSynthesis === 'undefined') return;
      try { speechSynthesis.cancel(); } catch (error) { }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'it-IT';
      utterance.rate = 0.95;
      try { speechSynthesis.speak(utterance); } catch (error) { }
    }

    bins.forEach(bin => {
      const role = bin.dataset.role;
      const drop = bin.querySelector('.drop');
      drop.addEventListener('dragover', event => event.preventDefault());
      drop.addEventListener('drop', event => handleDrop(event, role));
    });

    gear.addEventListener('click', () => {
      const hidden = settings.classList.toggle('hidden');
      gear.setAttribute('aria-expanded', String(!hidden));
    });

    document.addEventListener('click', event => {
      if (!settings.contains(event.target) && event.target !== gear) {
        settings.classList.add('hidden');
        gear.setAttribute('aria-expanded', 'false');
      }
    });

    training.addEventListener('change', () => {
      if (!training.checked) {
        stepIndex = 0;
      } else {
        stepIndex = computeStepFromProgress();
      }
      syncGuidedUI();
      updateQuestion();
      updateModeHint();
    });

    speakQuestions.addEventListener('change', () => {
      if (!speakQuestions.checked && typeof speechSynthesis !== 'undefined') {
        speechSynthesis.cancel();
      }
    });

    contrastToggle.addEventListener('change', event => {
      document.body.classList.toggle('high-contrast', event.target.checked);
    });

    fontsize.addEventListener('input', () => {
      document.body.style.fontSize = `${fontsize.value}%`;
    });

    picker.addEventListener('change', event => {
      loadSentence(event.target.value);
    });

    resetButton.addEventListener('click', () => {
      loadSentence(current.id);
    });

    nextButton.addEventListener('click', () => {
      const index = SENTENCES.findIndex(sentence => sentence.id === current.id);
      const nextIndex = (index + 1) % SENTENCES.length;
      loadSentence(SENTENCES[nextIndex].id);
    });

    speakSentenceButton.addEventListener('click', () => {
      tts(current.label);
    });

    printButton.addEventListener('click', () => window.print());

    function computeStepFromProgress(ignoreTraining = false) {
      if (!ignoreTraining && !training.checked) return 0;
      for (let index = 0; index < ORDER.length; index++) {
        const role = ORDER[index];
        const total = current.tokens.filter(tok => tok.role === role).length;
        const placed = Array.from(drops[role].children).filter(chip => chip.dataset.role === role).length;
        if (placed < total) {
          return index;
        }
      }
      return ORDER.length - 1;
    }

    renderPicker();
    loadSentence(SENTENCES[0].id);

    window.addEventListener('beforeunload', () => {
      if (typeof speechSynthesis === 'undefined') return;
      try { speechSynthesis.cancel(); } catch (error) { }
    });
  </script>
</body>
</html>
