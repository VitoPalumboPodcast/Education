<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analisi Logica - Versione Semplificata</title>
  <style>
    :root {
      --base-font-size: 20px;
      --bg: #f5f5f5;
      --panel: #ffffff;
      --ink: #222222;
      --muted: #d7e3ff;
      --chi: #4f46e5;
      --fa: #f97316;
      --cosa: #22c55e;
      --feedback-ok: #0f766e;
      --feedback-ko: #b91c1c;
      --shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
      --border-radius: 24px;
    }

    body {
      margin: 0;
      font-family: "Atkinson Hyperlegible", Arial, sans-serif;
      font-size: var(--base-font-size);
      background: var(--bg);
      color: var(--ink);
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    body.high-contrast {
      --bg: #0f172a;
      --panel: #111827;
      --ink: #f8fafc;
      --muted: #1f2937;
      --shadow: none;
    }

    .app {
      width: min(900px, 100%);
      background: var(--panel);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    h1 {
      margin: 0;
      font-size: 1.6em;
      line-height: 1.1;
    }

    .settings-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      color: inherit;
      font-size: 1em;
    }

    .settings-button:hover,
    .settings-button:focus-visible {
      background: rgba(79, 70, 229, 0.15);
      outline: none;
    }

    .sentence {
      background: var(--muted);
      padding: 16px;
      border-radius: 18px;
      font-weight: 700;
      text-align: center;
    }

    .mode-hint {
      margin: 0;
      text-align: center;
      font-size: 0.95em;
      color: #475569;
    }

    body.high-contrast .mode-hint {
      color: #cbd5f5;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .step {
      flex: 1;
      padding: 12px;
      border-radius: 16px;
      background: #e2e8f0;
      text-align: center;
      font-weight: 700;
      opacity: 0.6;
      transition: transform 0.2s, opacity 0.2s;
    }

    .step.active {
      opacity: 1;
      transform: scale(1.02);
    }

    .step.done {
      background: #bfdbfe;
    }

    .baskets {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .basket {
      border-radius: 24px;
      padding: 16px;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border: 6px solid transparent;
      background: rgba(15, 23, 42, 0.04);
      transition: border-color 0.2s, transform 0.2s;
    }

    .basket h2 {
      margin: 0;
      font-size: 1.4em;
    }

    .basket[data-role="fa"] {
      background: rgba(249, 115, 22, 0.12);
    }

    .basket[data-role="chi"] {
      background: rgba(79, 70, 229, 0.12);
    }

    .basket[data-role="cosa"] {
      background: rgba(34, 197, 94, 0.12);
    }

    .basket.active {
      border-color: currentColor;
      transform: scale(1.01);
    }

    .basket[data-role="fa"].active {
      color: var(--fa);
    }

    .basket[data-role="chi"].active {
      color: var(--chi);
    }

    .basket[data-role="cosa"].active {
      color: var(--cosa);
    }

    .basket-words {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 90px;
    }

    .word-bank {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .token {
      padding: 10px 14px;
      border-radius: 16px;
      background: #ffffff;
      border: 3px solid transparent;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s, border-color 0.2s, background 0.2s;
    }

    body.high-contrast .token {
      background: #1f2937;
      border-color: #475569;
    }

    .token:active {
      transform: scale(0.96);
    }

    .token[data-role="chi"] { border-color: rgba(79, 70, 229, 0.4); }
    .token[data-role="fa"] { border-color: rgba(249, 115, 22, 0.4); }
    .token[data-role="cosa"] { border-color: rgba(34, 197, 94, 0.4); }

    .token.locked {
      opacity: 0.5;
      pointer-events: none;
    }

    .feedback {
      text-align: center;
      min-height: 32px;
      font-weight: 800;
    }

    .feedback.ok {
      color: var(--feedback-ok);
    }

    .feedback.ko {
      color: var(--feedback-ko);
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .controls button {
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 1em;
      font-weight: 700;
      cursor: pointer;
      background: #1f2937;
      color: #ffffff;
    }

    .controls button.secondary {
      background: #4f46e5;
    }

    .hidden {
      display: none !important;
    }

    .settings-panel {
      position: absolute;
      right: 24px;
      top: 70px;
      background: var(--panel);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
      width: 220px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border: 2px solid rgba(15, 23, 42, 0.1);
      z-index: 10;
    }

    .settings-panel label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
    }

    .settings-panel input[type="range"] {
      width: 100%;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .toggle input {
      width: 20px;
      height: 20px;
    }

    @media (max-width: 680px) {
      body {
        padding: 16px;
      }

      .app {
        padding: 16px;
      }

      h1 {
        font-size: 1.3em;
      }
    }

    @media print {
      body {
        background: #ffffff;
        padding: 0;
      }

      .app {
        box-shadow: none;
        border-radius: 0;
      }

      .settings-button,
      .controls,
      .feedback {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Analisi logica: Chi – Fa – Cosa</h1>
      <button class="settings-button" id="settingsToggle" aria-label="Impostazioni">
        ⚙️
      </button>
    </header>

    <section class="sentence" id="sentenceText" aria-live="polite"></section>

    <p class="mode-hint" id="modeHint" role="status" aria-live="polite"></p>

    <div class="step-indicator" aria-hidden="true">
      <div class="step" data-role="fa">1. Trova FA (verbo)</div>
      <div class="step" data-role="chi">2. Trova CHI</div>
      <div class="step" data-role="cosa">3. Tutto il resto</div>
    </div>

    <section class="word-bank" id="wordBank" aria-label="Parole da inserire"></section>

    <section class="baskets" aria-live="polite">
      <div class="basket" data-role="fa" data-step="0" tabindex="0">
        <h2>FA (verbo)</h2>
        <div class="basket-words" aria-label="Parole del verbo"></div>
      </div>
      <div class="basket" data-role="chi" data-step="1" tabindex="0">
        <h2>CHI</h2>
        <div class="basket-words" aria-label="Parole del soggetto"></div>
      </div>
      <div class="basket" data-role="cosa" data-step="2" tabindex="0">
        <h2>COSA / ALTRO</h2>
        <div class="basket-words" aria-label="Parole degli altri pezzi"></div>
      </div>
    </section>

    <div class="feedback" id="feedback" aria-live="assertive"></div>

    <div class="controls">
      <button id="resetSentence">↺ Ricomincia</button>
      <button class="secondary" id="nextSentence">→ Frase nuova</button>
    </div>
  </div>

  <div class="settings-panel hidden" id="settingsPanel">
    <label class="toggle">
      <input type="checkbox" id="guidedToggle" checked />
      Percorso guidato (Chi → Fa → Cosa)
    </label>
    <label class="toggle">
      <input type="checkbox" id="speechToggle" />
      Suggerimenti vocali
    </label>
    <label>
      Dimensione testo
      <input type="range" id="fontSlider" min="18" max="28" value="20" />
    </label>
    <label class="toggle">
      <input type="checkbox" id="contrastToggle" />
      Contrasto alto
    </label>
  </div>

  <script>
    const SENTENCES = [
      {
        text: "Marco mangia la mela rossa.",
        tokens: [
          { word: "Marco", role: "chi" },
          { word: "mangia", role: "fa" },
          { word: "la", role: "cosa" },
          { word: "mela", role: "cosa" },
          { word: "rossa", role: "cosa" }
        ]
      },
      {
        text: "La maestra legge una storia divertente.",
        tokens: [
          { word: "La", role: "chi" },
          { word: "maestra", role: "chi" },
          { word: "legge", role: "fa" },
          { word: "una", role: "cosa" },
          { word: "storia", role: "cosa" },
          { word: "divertente", role: "cosa" }
        ]
      },
      {
        text: "Il cane corre nel parco verde.",
        tokens: [
          { word: "Il", role: "chi" },
          { word: "cane", role: "chi" },
          { word: "corre", role: "fa" },
          { word: "nel", role: "cosa" },
          { word: "parco", role: "cosa" },
          { word: "verde", role: "cosa" }
        ]
      }
    ];

    const wordBank = document.getElementById("wordBank");
    const sentenceText = document.getElementById("sentenceText");
    const modeHint = document.getElementById("modeHint");
    const feedback = document.getElementById("feedback");
    const steps = Array.from(document.querySelectorAll(".step"));
    const baskets = Array.from(document.querySelectorAll(".basket"));
    const resetButton = document.getElementById("resetSentence");
    const nextButton = document.getElementById("nextSentence");
    const settingsToggle = document.getElementById("settingsToggle");
    const settingsPanel = document.getElementById("settingsPanel");
    const fontSlider = document.getElementById("fontSlider");
    const contrastToggle = document.getElementById("contrastToggle");
    const guidedToggle = document.getElementById("guidedToggle");
    const speechToggle = document.getElementById("speechToggle");

    let currentSentenceIndex = 0;
    let currentSentence = null;
    let currentStep = 0;
    let guidedMode = true;
    let speechEnabled = false;

    const ROLE_MESSAGES = {
      fa: "Bravo! Hai trovato il FA (verbo).",
      chi: "Ottimo! Hai individuato il CHI.",
      cosa: "Ben fatto! Questo pezzo completa la frase."
    };

    const ERROR_MESSAGES = {
      fa: "Per prima cosa scegli un verbo (FA).",
      chi: "Adesso trova chi compie l'azione.",
      cosa: "Ora trascina gli altri pezzi della frase."
    };

    const NEXT_STEP_HINTS = {
      chi: "Ora cerca chi compie l'azione.",
      cosa: "Completa con gli altri pezzi della frase."
    };

    const STEP_HINTS = {
      fa: "Cerca nella frase il FA: il verbo dell'azione.",
      chi: "Trova chi compie l'azione descritta.",
      cosa: "Sposta tutti gli altri pezzi nel cesto COSA / ALTRO."
    };

    guidedMode = guidedToggle.checked;
    speechEnabled = speechToggle.checked;

    function shuffle(array) {
      const copy = [...array];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function setStep(stepIndex) {
      currentStep = stepIndex;
      if (!guidedMode) {
        steps.forEach((step) => {
          step.classList.remove("active", "done");
        });
        baskets.forEach((basket) => {
          basket.classList.remove("active");
        });
        updateModeHint();
        return;
      }
      steps.forEach((step) => {
        const role = step.dataset.role;
        const roleIndex = role === "fa" ? 0 : role === "chi" ? 1 : 2;
        step.classList.toggle("active", roleIndex === stepIndex);
        step.classList.toggle("done", roleIndex < stepIndex);
      });
      baskets.forEach((basket) => {
        const basketStep = Number(basket.dataset.step);
        basket.classList.toggle("active", basketStep === stepIndex);
      });
      updateModeHint();
    }

    function populateSentence(index) {
      currentSentence = SENTENCES[index % SENTENCES.length];
      sentenceText.textContent = currentSentence.text;
      feedback.textContent = "";
      feedback.className = "feedback";
      feedback.removeAttribute("role");
      wordBank.innerHTML = "";
      baskets.forEach((basket) => {
        basket.querySelector(".basket-words").innerHTML = "";
      });
      const shuffledTokens = shuffle(currentSentence.tokens);
      shuffledTokens.forEach((tokenData, idx) => {
        const token = document.createElement("button");
        token.type = "button";
        token.textContent = tokenData.word;
        token.className = "token";
        token.dataset.role = tokenData.role;
        token.dataset.index = idx;
        token.draggable = true;
        token.addEventListener("click", () => handleTokenPlacement(token));
        token.addEventListener("dragstart", handleDragStart);
        token.addEventListener("dragend", handleDragEnd);
        wordBank.appendChild(token);
      });
      setStep(0);
      synchronizeMode();
    }

    function handleTokenPlacement(token) {
      if (!token || token.classList.contains("locked")) return;
      const tokenRole = token.dataset.role;
      if (guidedMode) {
        const targetRole = getRoleByStep(currentStep);
        if (tokenRole !== targetRole) {
          showFeedback(false, ERROR_MESSAGES[targetRole] || "Prova con un'altra parola.");
          return;
        }
        dropTokenIntoBasket(token, targetRole);
        checkProgress();
        return;
      }
      dropTokenIntoBasket(token, tokenRole);
      checkProgress();
    }

    function getRoleByStep(stepIndex) {
      return stepIndex === 0 ? "fa" : stepIndex === 1 ? "chi" : "cosa";
    }

    function dropTokenIntoBasket(token, role) {
      const basket = baskets.find((b) => b.dataset.role === role);
      if (!basket) return;
      basket.querySelector(".basket-words").appendChild(token);
      token.classList.add("locked");
      token.setAttribute("aria-disabled", "true");
      showFeedback(true, ROLE_MESSAGES[role] || "Bravo!");
      updateModeHint();
    }

    function checkProgress() {
      if (!currentSentence) return;
      if (!guidedMode) {
        if (isSentenceComplete()) {
          showCompletion();
        }
        return;
      }
      const role = getRoleByStep(currentStep);
      const totalNeeded = totalTokensForRole(role);
      if (totalNeeded === 0) {
        if (currentStep < 2) {
          setStep(currentStep + 1);
        } else {
          showCompletion();
        }
        return;
      }
      const placed = countLockedTokens(role);
      if (placed >= totalNeeded) {
        if (currentStep < 2) {
          const nextStep = currentStep + 1;
          setStep(nextStep);
          const nextRole = getRoleByStep(nextStep);
          const hint = NEXT_STEP_HINTS[nextRole];
          if (hint) {
            showFeedback(true, hint);
          }
        } else {
          showCompletion();
        }
      }
    }

    function showFeedback(isOk, message) {
      const text = message || (isOk ? "Bravo!" : "Oops!");
      feedback.textContent = text;
      feedback.classList.toggle("ok", isOk);
      feedback.classList.toggle("ko", !isOk);
      if (!isOk) {
        feedback.setAttribute("role", "alert");
        setTimeout(() => feedback.removeAttribute("role"), 500);
      } else {
        feedback.removeAttribute("role");
      }
      speakMessage(text);
    }

    function showCompletion() {
      showFeedback(true, "Bravo! Tutto completo");
      updateModeHint();
    }

    function countLockedTokens(role) {
      const basket = baskets.find((b) => b.dataset.role === role);
      if (!basket) return 0;
      return basket.querySelectorAll(`.token.locked[data-role="${role}"]`).length;
    }

    function totalTokensForRole(role) {
      if (!currentSentence) return 0;
      return currentSentence.tokens.filter((token) => token.role === role).length;
    }

    function isSentenceComplete() {
      if (!currentSentence) return false;
      return document.querySelectorAll(".token:not(.locked)").length === 0;
    }

    function updateModeHint() {
      if (!modeHint) return;
      if (isSentenceComplete()) {
        modeHint.textContent = "Frase completata! Ottimo lavoro.";
        return;
      }
      if (!guidedMode) {
        const remaining = document.querySelectorAll(".token:not(.locked)").length;
        modeHint.textContent = remaining > 0
          ? `Modalità libera: abbina le parole ai cestini corretti (${remaining} da sistemare).`
          : "Modalità libera: tutti i pezzi sono al posto giusto!";
        return;
      }
      const role = getRoleByStep(currentStep);
      modeHint.textContent = STEP_HINTS[role] || "Completa l'attività seguendo l'ordine.";
    }

    function speakMessage(text) {
      if (!speechEnabled || !text) return;
      if (typeof speechSynthesis === "undefined") return;
      speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "it-IT";
      utterance.rate = 1;
      speechSynthesis.speak(utterance);
    }

    function synchronizeMode() {
      if (guidedMode) {
        synchronizeStepWithProgress();
      } else {
        setStep(currentStep);
      }
    }

    function synchronizeStepWithProgress() {
      if (!guidedMode) return;
      const roles = ["fa", "chi", "cosa"];
      for (let index = 0; index < roles.length; index++) {
        const role = roles[index];
        if (countLockedTokens(role) < totalTokensForRole(role)) {
          setStep(index);
          return;
        }
      }
      setStep(2);
      if (isSentenceComplete()) {
        showCompletion();
      }
    }

    let draggedToken = null;

    function handleDragStart(event) {
      draggedToken = event.target;
      event.dataTransfer.effectAllowed = "move";
    }

    function handleDragEnd() {
      draggedToken = null;
    }

    baskets.forEach((basket) => {
      basket.addEventListener("dragover", (event) => {
        event.preventDefault();
      });
      basket.addEventListener("drop", (event) => {
        event.preventDefault();
        if (!draggedToken || draggedToken.classList.contains("locked")) return;
        const tokenRole = draggedToken.dataset.role;
        const basketRole = basket.dataset.role;
        if (guidedMode) {
          const expectedRole = getRoleByStep(currentStep);
          if (basketRole !== expectedRole || tokenRole !== expectedRole) {
            showFeedback(false, ERROR_MESSAGES[expectedRole] || "Segui l'ordine guidato.");
            return;
          }
          dropTokenIntoBasket(draggedToken, expectedRole);
          checkProgress();
          return;
        }
        if (tokenRole !== basketRole) {
          showFeedback(false, `In questo cesto vanno parole di tipo ${basketRole.toUpperCase()}.`);
          return;
        }
        dropTokenIntoBasket(draggedToken, basketRole);
        checkProgress();
      });
    });

    guidedToggle.addEventListener("change", (event) => {
      guidedMode = event.target.checked;
      synchronizeMode();
    });

    speechToggle.addEventListener("change", (event) => {
      speechEnabled = event.target.checked;
      if (!speechEnabled && typeof speechSynthesis !== "undefined") {
        speechSynthesis.cancel();
      }
    });

    resetButton.addEventListener("click", () => populateSentence(currentSentenceIndex));

    nextButton.addEventListener("click", () => {
      currentSentenceIndex = (currentSentenceIndex + 1) % SENTENCES.length;
      populateSentence(currentSentenceIndex);
    });

    settingsToggle.addEventListener("click", () => {
      settingsPanel.classList.toggle("hidden");
    });

    fontSlider.addEventListener("input", (event) => {
      const value = event.target.value;
      document.documentElement.style.setProperty("--base-font-size", `${value}px`);
    });

    contrastToggle.addEventListener("change", (event) => {
      document.body.classList.toggle("high-contrast", event.target.checked);
    });

    document.addEventListener("click", (event) => {
      if (!settingsPanel.contains(event.target) && event.target !== settingsToggle) {
        settingsPanel.classList.add("hidden");
      }
    });

    populateSentence(currentSentenceIndex);
  </script>
</body>
</html>
